<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>MAMA - Memory-Augmented Assistant</title>

    <meta name="theme-color" content="#EDDBF7" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MAMA" />
    <link rel="apple-touch-icon" href="/viewer/icons/icon-192.png" />
    <link rel="manifest" href="/viewer/manifest.json" crossorigin="use-credentials" />
    <link rel="icon" type="image/svg+xml" href="/viewer/icons/mama-icon.svg" />
    <link rel="icon" type="image/png" sizes="192x192" href="/viewer/icons/icon-192.png" />

    <!-- Preconnect to CDN origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />

    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script" />
    <link rel="preload" href="/viewer/viewer.css" as="style" />

    <!-- Fonts with reduced weights -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;700&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- External libraries with defer -->
    <script defer src="https://unpkg.com/vis-network@9/dist/vis-network.min.js"></script>
    <script defer src="https://unpkg.com/lucide@0.460.0"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/marked@11/marked.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.5/purify.min.js"></script>
    <!-- Tailwind must load synchronously -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              background: 'hsl(var(--background))',
              foreground: 'hsl(var(--foreground))',
              card: 'hsl(var(--card))',
              'card-foreground': 'hsl(var(--card-foreground))',
              border: 'hsl(var(--border))',
              muted: 'hsl(var(--muted))',
              'muted-foreground': 'hsl(var(--muted-foreground))',
              primary: 'hsl(var(--primary))',
              'primary-foreground': 'hsl(var(--primary-foreground))',
              secondary: 'hsl(var(--secondary))',
              'secondary-foreground': 'hsl(var(--secondary-foreground))',
              destructive: 'hsl(var(--destructive))',
              'destructive-foreground': 'hsl(var(--destructive-foreground))',
              success: 'hsl(var(--success))',
              warning: 'hsl(var(--warning))',
              info: 'hsl(var(--info))',
              ring: 'hsl(var(--ring))',
              mama: {
                yellow: '#FFCE00',
                'yellow-hover': '#E6B800',
                lavender: '#EDDBF7',
                'lavender-light': '#F5EBF9',
                'lavender-dark': '#D4C4E0',
                black: '#131313',
                blush: '#FF9999',
              },
            },
            spacing: {
              'header': 'var(--header-height)',
              'sidebar': 'var(--sidebar-width)',
            },
            borderRadius: {
              DEFAULT: 'var(--radius)',
              sm: 'var(--radius-sm)',
              lg: 'var(--radius-lg)',
              xl: 'var(--radius-xl)',
            },
            fontFamily: {
              display: ['Fredoka', 'sans-serif'],
              body: ['Nunito', 'sans-serif'],
              sans: ['Nunito', 'sans-serif'],
              mono: ['var(--font-mono)', 'monospace'],
            },
            boxShadow: {
              'soft': '0 4px 20px rgba(19, 19, 19, 0.08)',
              'medium': '0 8px 32px rgba(19, 19, 19, 0.12)',
              'float': '0 12px 40px rgba(19, 19, 19, 0.15)',
              'yellow': '0 4px 20px rgba(255, 206, 0, 0.4)',
            },
          }
        }
      }
    </script>
    <style>
      :root {
        /* MAMA Brand Colors */
        --mama-yellow: #FFCE00;
        --mama-yellow-hover: #E6B800;
        --mama-lavender: #EDDBF7;
        --mama-lavender-light: #F5EBF9;
        --mama-lavender-dark: #D4C4E0;
        --mama-black: #131313;
        --mama-blush: #FF9999;

        /* Semantic Colors (HSL for Tailwind) */
        --background: 280 55% 93%;  /* lavender */
        --foreground: 0 0% 7%;      /* black */
        --card: 0 0% 100%;          /* white */
        --card-foreground: 0 0% 7%;
        --border: 0 0% 91%;         /* light gray */
        --muted: 280 55% 96%;       /* lavender-light */
        --muted-foreground: 0 0% 53%;
        --primary: 48 100% 50%;     /* yellow */
        --primary-foreground: 0 0% 7%;
        --secondary: 280 55% 96%;   /* lavender-light */
        --secondary-foreground: 0 0% 7%;
        --destructive: 0 84% 60%;
        --destructive-foreground: 0 0% 98%;
        --success: 142 76% 36%;
        --warning: 38 92% 50%;
        --info: 199 89% 48%;
        --ring: 48 100% 50%;        /* yellow */

        /* Layout */
        --radius: 0.75rem;
        --radius-sm: 0.5rem;
        --radius-lg: 1.25rem;
        --radius-xl: 1.5rem;
        --header-height: 56px;
        --sidebar-width: 280px;
        --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      }
    </style>

    <link rel="stylesheet" href="/viewer/viewer.css" />
  </head>
  <body class="bg-mama-lavender text-mama-black font-body">
    <div id="app" class="h-screen flex flex-col">
      <!-- Header -->
      <header class="fixed top-0 left-0 right-0 h-14 bg-white/95 backdrop-blur-md border-b border-gray-200 shadow-soft z-50">
        <div class="h-full max-w-[1920px] mx-auto px-4 flex items-center justify-between">
          <!-- Logo -->
          <a href="/" class="flex items-center gap-2 text-lg font-display font-bold hover:opacity-80 transition-opacity">
            <img src="/viewer/icons/mama-icon.svg" alt="MAMA" class="w-8 h-8">
            <span class="hidden sm:inline">MAMA</span>
          </a>

          <!-- Navigation Tabs -->
          <nav class="flex items-center gap-1" id="nav-tabs">
            <button
              class="hidden px-3 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-mama-lavender-light"
              data-tab="setup"
              onclick="window.switchTab && window.switchTab('setup')"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
                />
                <circle cx="12" cy="12" r="3" />
              </svg>
              <span class="hidden sm:inline">Setup</span>
            </button>
            <button class="px-3 py-1.5 rounded-full text-sm font-semibold transition-all hover:bg-mama-lavender-light flex items-center gap-2" data-tab="dashboard" onclick="window.switchTab && window.switchTab('dashboard')">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="7" height="7" />
                <rect x="14" y="3" width="7" height="7" />
                <rect x="14" y="14" width="7" height="7" />
                <rect x="3" y="14" width="7" height="7" />
              </svg>
              <span class="hidden sm:inline">Dashboard</span>
            </button>
            <button class="px-3 py-1.5 rounded-full text-sm font-semibold transition-all hover:bg-mama-lavender-light flex items-center gap-2" data-tab="skills" onclick="window.switchTab && window.switchTab('skills')">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 2L2 7l10 5 10-5-10-5z" />
                <path d="M2 17l10 5 10-5" />
                <path d="M2 12l10 5 10-5" />
              </svg>
              <span class="hidden sm:inline">Skills</span>
            </button>
            <button class="px-3 py-1.5 rounded-full text-sm font-semibold transition-all hover:bg-mama-lavender-light flex items-center gap-2" data-tab="memory" onclick="window.switchTab && window.switchTab('memory')">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
                />
                <polyline points="3.29 7 12 12 20.71 7" />
                <line x1="12" y1="22" x2="12" y2="12" />
              </svg>
              <span class="hidden sm:inline">Memory</span>
            </button>
            <button class="px-3 py-1.5 rounded-full text-sm font-semibold transition-all hover:bg-mama-lavender-light flex items-center gap-2" data-tab="settings" onclick="window.switchTab && window.switchTab('settings')">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
              </svg>
              <span class="hidden sm:inline">Settings</span>
            </button>
          </nav>

          <!-- Header Actions -->
          <div class="flex items-center gap-2">
            <button
              class="p-2 rounded-full hover:bg-mama-lavender-light transition-colors"
              onclick="showTunnelSetup()"
              title="External Access"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <line x1="2" y1="12" x2="22" y2="12" />
                <path
                  d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-1 pt-14 overflow-hidden flex flex-col">
        <!-- Setup tab hidden: runs on port 3848 -->
        <div class="tab-content" id="tab-setup" style="display: none">
          <div class="setup-container">
            <div class="progress-section" id="progress-section" style="display: none">
              <div class="progress-header">
                <span class="progress-label" id="progress-label">Getting started...</span>
                <span class="progress-count" id="progress-count">1 / 9</span>
              </div>
              <div class="progress-bar" id="progress-bar">
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
              </div>
            </div>

            <div class="chat-container" id="setup-chat">
              <div class="chat-messages" id="setup-messages"></div>

              <div class="typing-indicator" id="setup-typing">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>

              <div class="chat-input-area">
                <div class="input-row">
                  <div class="input-wrapper">
                    <textarea
                      class="chat-input"
                      id="setup-input"
                      placeholder="Type your message..."
                      rows="1"
                      disabled
                    ></textarea>
                  </div>
                  <button
                    class="btn btn-send"
                    id="setup-send"
                    onclick="sendSetupMessage()"
                    disabled
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                    <span>Send</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content" id="tab-dashboard">
          <div class="flex-1 flex flex-col min-h-0 overflow-y-auto p-4 md:p-6">
            <!-- Header -->
            <div class="mb-4">
              <h1 class="text-xl font-bold text-mama-black">MAMA OS Dashboard</h1>
              <p class="text-xs text-gray-500 mt-0.5">System status overview</p>
            </div>

            <!-- Row 1: Gateway + MCP (Connectivity) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <!-- Gateway Status -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">üåê Gateways</h2>
                <div id="dashboard-gateways" class="grid grid-cols-2 gap-2">
                  <div class="animate-pulse bg-white rounded-lg h-20"></div>
                  <div class="animate-pulse bg-white rounded-lg h-20"></div>
                  <div class="animate-pulse bg-white rounded-lg h-20"></div>
                  <div class="animate-pulse bg-white rounded-lg h-20"></div>
                </div>
              </section>

              <!-- MCP Servers -->
              <section>
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-sm font-semibold text-gray-900">üîå MCP Servers</h2>
                  <button onclick="window.dashboardModule?.loadMCPServers()"
                    class="text-[10px] text-gray-400 hover:text-mama-yellow-hover">‚Üª</button>
                </div>
                <div id="dashboard-mcp" class="grid grid-cols-2 gap-2">
                  <div class="animate-pulse bg-white rounded-lg h-16"></div>
                  <div class="animate-pulse bg-white rounded-lg h-16"></div>
                  <div class="animate-pulse bg-white rounded-lg h-16"></div>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">~/.mama/mama-mcp-config.json</p>
              </section>
            </div>

            <!-- Row 2: Agent Swarm + Sessions (Activity) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <!-- Agent Swarm -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">üé≠ Agent Swarm</h2>
                <div id="dashboard-agent-swarm" class="bg-white border border-gray-200 rounded-lg p-2.5">
                  <div class="animate-pulse space-y-1.5">
                    <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                    <div class="h-3 bg-gray-100 rounded w-3/4"></div>
                  </div>
                </div>
              </section>

              <!-- Active Sessions -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">üí¨ Active Sessions</h2>
                <div id="dashboard-sessions" class="bg-white border border-gray-200 rounded-lg p-2.5">
                  <div class="animate-pulse space-y-1.5">
                    <div class="h-3 bg-gray-100 rounded w-1/3"></div>
                    <div class="h-3 bg-gray-100 rounded w-full"></div>
                  </div>
                </div>
              </section>
            </div>

            <!-- Row 3: Agent Config + Memory Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <!-- Agent Configuration -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">ü§ñ Agent Config</h2>
                <div id="dashboard-agent" class="bg-white border border-gray-200 rounded-lg p-2.5">
                  <div class="animate-pulse space-y-1.5">
                    <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                    <div class="h-3 bg-gray-100 rounded w-1/3"></div>
                  </div>
                </div>
              </section>

              <!-- Memory Stats -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">üß† Memory</h2>
                <div id="dashboard-memory" class="grid grid-cols-4 gap-2">
                  <div class="animate-pulse bg-white rounded-lg h-14"></div>
                  <div class="animate-pulse bg-white rounded-lg h-14"></div>
                  <div class="animate-pulse bg-white rounded-lg h-14"></div>
                  <div class="animate-pulse bg-white rounded-lg h-14"></div>
                </div>
              </section>
            </div>

            <!-- Row 4: Token + Cron (Usage) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <!-- Token Usage -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">üìä Token Usage</h2>
                <div id="dashboard-tokens" class="bg-white border border-gray-200 rounded-lg p-2.5">
                  <div class="animate-pulse space-y-1.5">
                    <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                    <div class="h-3 bg-gray-100 rounded w-3/4"></div>
                  </div>
                </div>
              </section>

              <!-- Cron Monitor -->
              <section>
                <h2 class="text-sm font-semibold text-gray-900 mb-2">‚è∞ Cron Jobs</h2>
                <div id="dashboard-cron" class="bg-white border border-gray-200 rounded-lg p-2.5">
                  <div class="animate-pulse space-y-1.5">
                    <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                    <div class="h-3 bg-gray-100 rounded w-3/4"></div>
                  </div>
                </div>
              </section>
            </div>

            <!-- Row 5: Top Topics (Secondary) -->
            <section class="mb-4">
              <h2 class="text-sm font-semibold text-gray-900 mb-2">üìà Top Topics</h2>
              <div id="dashboard-topics" class="bg-white border border-gray-200 rounded-lg p-2.5">
                <div class="animate-pulse space-y-1.5">
                  <div class="h-3 bg-gray-100 rounded w-3/4"></div>
                  <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                </div>
              </div>
            </section>

            <!-- Status Bar -->
            <div id="dashboard-status" class="text-xs text-gray-400 text-center py-1">
              Loading...
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
          <div class="flex-1 flex flex-col min-h-0 overflow-y-auto p-2 md:p-3">
            <!-- Compact Header -->
            <div class="flex items-center justify-between mb-3">
              <h1 class="text-sm font-bold text-gray-900">‚öôÔ∏è Settings</h1>
              <span class="text-[10px] text-gray-400">MAMA OS Configuration</span>
            </div>

            <!-- Main Grid: 2 columns on desktop -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">

              <!-- Left Column -->
              <div class="space-y-3">

                <!-- Gateway Connections - 2x2 Grid -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üåê Gateways</h2>
                  <div class="grid grid-cols-2 gap-1.5">
                    <!-- Discord -->
                    <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-medium">üí¨ Discord</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="settings-discord-enabled" class="sr-only peer" aria-label="Enable Discord">
                          <div class="w-6 h-3.5 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                      </div>
                      <input type="password" id="settings-discord-token" placeholder="Bot Token" aria-label="Discord bot token" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50 mb-1">
                      <input type="text" id="settings-discord-channel" placeholder="Channel ID" aria-label="Discord channel ID" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                    </div>
                    <!-- Slack -->
                    <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-medium">üì± Slack</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="settings-slack-enabled" class="sr-only peer" aria-label="Enable Slack">
                          <div class="w-6 h-3.5 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                      </div>
                      <input type="password" id="settings-slack-bot-token" placeholder="Bot Token (xoxb-)" aria-label="Slack bot token" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50 mb-1">
                      <input type="password" id="settings-slack-app-token" placeholder="App Token (xapp-)" aria-label="Slack app token" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                    </div>
                    <!-- Telegram -->
                    <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-medium">‚úàÔ∏è Telegram</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="settings-telegram-enabled" class="sr-only peer" aria-label="Enable Telegram">
                          <div class="w-6 h-3.5 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                      </div>
                      <input type="password" id="settings-telegram-token" placeholder="Bot Token" aria-label="Telegram bot token" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                    </div>
                    <!-- Chatwork -->
                    <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-medium">üíº Chatwork</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="settings-chatwork-enabled" class="sr-only peer" aria-label="Enable Chatwork">
                          <div class="w-6 h-3.5 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                      </div>
                      <input type="password" id="settings-chatwork-token" placeholder="API Token" aria-label="Chatwork API token" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                    </div>
                  </div>
                </section>

                <!-- Agent Config Card -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">ü§ñ Default Agent</h2>
                  <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                    <div class="grid grid-cols-2 gap-1.5 mb-2">
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Backend</label>
                        <select id="settings-agent-backend" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                          <option value="claude">Claude CLI</option>
                          <option value="codex-mcp">Codex MCP</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Model</label>
                        <select id="settings-agent-model" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50"></select>
                      </div>
                      <div id="settings-effort-container" style="display: none;">
                        <label class="block text-[9px] text-gray-500 mb-0.5">Effort <span class="text-indigo-500">(4.6)</span></label>
                        <select id="settings-agent-effort" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                          <option value="low">Low</option>
                          <option value="medium" selected>Medium</option>
                          <option value="high">High</option>
                          <option value="max">Max (Opus only)</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Max Turns</label>
                        <input type="number" id="settings-agent-max-turns" value="10" min="1" max="100" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Timeout (s)</label>
                        <input type="number" id="settings-agent-timeout" value="300" min="30" max="600" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Heartbeat Card -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">‚è∞ Heartbeat</h2>
                  <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-[10px] text-gray-600">Enable scheduler</span>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="settings-heartbeat-enabled" class="sr-only peer" aria-label="Enable heartbeat scheduler">
                        <div class="w-6 h-3.5 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-green-500"></div>
                      </label>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Interval (min)</label>
                        <input type="number" id="settings-heartbeat-interval" value="30" min="5" max="1440" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Quiet Start</label>
                        <input type="number" id="settings-heartbeat-quiet-start" value="23" min="0" max="23" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Quiet End</label>
                        <input type="number" id="settings-heartbeat-quiet-end" value="8" min="0" max="23" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Role Permissions -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üîê Roles</h2>
                  <div id="settings-roles-container" class="grid grid-cols-2 gap-1.5">
                    <div class="animate-pulse bg-white rounded-lg h-12"></div>
                    <div class="animate-pulse bg-white rounded-lg h-12"></div>
                  </div>
                </section>

              </div>

              <!-- Right Column -->
              <div class="space-y-3">

                <!-- Multi-Agent Team -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üë• Multi-Agent Team</h2>
                  <div id="settings-multi-agent-container">
                    <div class="animate-pulse bg-white rounded-lg h-20"></div>
                  </div>
                </section>

                <!-- Installed Skills -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üìö Skills</h2>
                  <div id="settings-skills-container" class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                    <p class="text-[10px] text-gray-500">Loading...</p>
                  </div>
                </section>

                <!-- Token Budget -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üí∞ Token Budget</h2>
                  <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                    <div class="grid grid-cols-2 gap-1.5">
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Daily Limit</label>
                        <input type="number" id="settings-token-daily-limit" placeholder="1000000" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                      <div>
                        <label class="block text-[9px] text-gray-500 mb-0.5">Alert ($)</label>
                        <input type="number" id="settings-token-alert-threshold" step="0.01" placeholder="5.00" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Scheduled Jobs -->
                <section>
                  <h2 class="text-xs font-semibold text-gray-700 mb-1.5 flex items-center gap-1">üìÖ Scheduled Jobs</h2>
                  <div id="settings-cron-container" class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm mb-1.5">
                    <p class="text-[10px] text-gray-500">Loading...</p>
                  </div>
                  <details class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <summary class="px-2 py-1.5 text-[10px] font-medium text-gray-600 cursor-pointer hover:bg-gray-50">+ Add New Job</summary>
                    <div class="p-2 border-t border-gray-100 space-y-1.5" id="settings-cron-form">
                      <div class="grid grid-cols-2 gap-1.5">
                        <input type="text" id="settings-cron-name" placeholder="Job Name" aria-label="Cron job name" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                        <input type="text" id="settings-cron-expr" placeholder="0 * * * *" aria-label="Cron expression" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50">
                      </div>
                      <textarea id="settings-cron-prompt" rows="2" placeholder="Task prompt..." aria-label="Cron job task prompt" class="w-full px-1.5 py-0.5 text-[10px] border border-gray-200 rounded bg-gray-50 resize-none"></textarea>
                      <button onclick="settingsModule.addCronJob()" class="w-full px-2 py-1 text-[10px] font-medium bg-yellow-400 hover:bg-yellow-300 rounded">Add</button>
                    </div>
                  </details>
                </section>

              </div>
            </div>

            <!-- Full Width: Tools Section (collapsible) -->
            <details class="mt-3">
              <summary class="text-xs font-semibold text-gray-700 cursor-pointer mb-1.5 flex items-center gap-1">üîß Tool Selection <span class="text-[9px] text-gray-400 font-normal">(click to expand)</span></summary>
              <div class="bg-white border border-gray-200 rounded-lg p-2 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500">Gateway</span>
                    <label class="flex items-center gap-1 text-[10px] cursor-pointer">
                      <input type="checkbox" id="gateway-select-all" onchange="settingsModule.toggleAllGateway(this.checked)" checked class="w-3 h-3" aria-label="Select all gateway tools">All
                    </label>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500">MCP</span>
                    <label class="flex items-center gap-1 text-[10px] cursor-pointer">
                      <input type="checkbox" id="mcp-select-all" onchange="settingsModule.toggleAllMCP(this.checked)" class="w-3 h-3" aria-label="Select all MCP tools">All
                    </label>
                  </div>
                </div>
                <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-1 mb-2">
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="mama_search" checked>mama_search</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="mama_save" checked>mama_save</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="mama_update" checked>mama_update</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="mama_load_checkpoint" checked>checkpoint</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="discord_send" checked>discord_send</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="Read" checked>Read</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="Write" checked>Write</label>
                  <label class="flex items-center gap-1 text-[9px] cursor-pointer"><input type="checkbox" class="gateway-tool w-2.5 h-2.5" value="Bash" checked>Bash</label>
                </div>
                <div id="mcp-tools-list" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-1 text-[9px] text-gray-400">Loading MCP...</div>
                <div class="mt-2 pt-2 border-t border-gray-100 text-[10px] text-gray-500" id="tool-summary">Gateway: 8 | MCP: 0</div>
              </div>
            </details>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
              <button onclick="settingsModule.resetForm()" class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded transition-colors">Reset</button>
              <div class="flex items-center gap-2">
                <span id="settings-status" class="text-[10px] text-gray-500"></span>
                <button onclick="settingsModule.saveAndRestart()" class="px-4 py-1.5 text-xs font-medium text-black bg-yellow-400 hover:bg-yellow-300 rounded transition-colors flex items-center gap-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                  Save &amp; Restart
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" id="tab-memory">
          <div class="flex-1 flex flex-col min-h-0">
            <!-- Analytics Bar (full width, top) -->
            <div class="border-b border-gray-200 bg-white">
              <div class="flex items-center justify-between px-3 py-1.5">
                <div class="flex items-center gap-3">
                  <div id="memory-stats-total" class="text-center">
                    <p class="text-lg font-bold text-gray-900">-</p>
                    <p class="text-[10px] text-gray-500">Total</p>
                  </div>
                  <div class="h-6 w-px bg-gray-200"></div>
                  <div id="memory-stats-week" class="text-center">
                    <p class="text-lg font-bold text-gray-900">-</p>
                    <p class="text-[10px] text-gray-500">This Week</p>
                  </div>
                  <div class="h-6 w-px bg-gray-200"></div>
                  <div id="memory-stats-outcomes" class="flex items-center gap-1.5">
                    <span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] rounded-full bg-green-100 text-green-700">
                      <span id="outcome-success">0</span> ‚úì
                    </span>
                    <span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] rounded-full bg-red-100 text-red-700">
                      <span id="outcome-failed">0</span> ‚úó
                    </span>
                    <span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] rounded-full bg-yellow-100 text-yellow-700">
                      <span id="outcome-partial">0</span> ~
                    </span>
                  </div>
                </div>
                <div class="flex items-center gap-1">
                  <button onclick="exportDecisions('json')" class="px-2 py-1 text-[10px] font-medium bg-gray-100 hover:bg-gray-200 text-gray-600 rounded transition-colors">JSON</button>
                  <button onclick="exportDecisions('markdown')" class="px-2 py-1 text-[10px] font-medium bg-gray-100 hover:bg-gray-200 text-gray-600 rounded transition-colors">MD</button>
                  <button onclick="exportDecisions('csv')" class="px-2 py-1 text-[10px] font-medium bg-gray-100 hover:bg-gray-200 text-gray-600 rounded transition-colors">CSV</button>
                </div>
              </div>
            </div>

            <!-- Filters Bar (full width) -->
            <div class="flex items-center gap-2 px-3 py-2 border-b border-gray-200 bg-gray-50/50">
              <!-- Toggle button for checkpoint sidebar -->
              <button
                id="checkpoint-sidebar-toggle"
                class="w-7 h-7 bg-white border border-gray-200 rounded flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                onclick="toggleCheckpointSidebar()"
                title="Toggle Checkpoints"
                aria-controls="checkpoint-sidebar"
                aria-expanded="true"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <line x1="3" y1="9" x2="21" y2="9" />
                  <line x1="9" y1="21" x2="9" y2="9" />
                </svg>
              </button>
              <select class="px-2 py-1 bg-white border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-yellow-400" id="topic-filter" onchange="filterByTopic(this.value)">
                <option value="">All Topics</option>
              </select>
              <select class="px-2 py-1 bg-white border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-yellow-400" id="outcome-filter" onchange="filterByOutcome(this.value)">
                <option value="">All Outcomes</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
                <option value="partial">Partial</option>
                <option value="pending">Pending</option>
              </select>
              <input type="text" class="px-2 py-1 bg-white border border-gray-200 rounded text-xs placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-yellow-400 flex-1 max-w-[160px]" id="search-input" placeholder="Search..." onkeyup="handleGraphSearch(event)" />
              <button onclick="clearFilters()" class="px-2 py-1 text-[10px] text-gray-400 hover:text-gray-600">Clear</button>
            </div>

            <!-- Main content area: Sidebar + Graph -->
            <div class="flex-1 flex min-h-0 relative">
              <!-- Checkpoint Sidebar -->
              <aside id="checkpoint-sidebar" class="checkpoint-sidebar w-56 border-r border-gray-200 bg-gray-50 flex flex-col min-h-0 overflow-hidden" style="min-width: 120px; max-width: 400px;">
                <div class="p-2 border-b border-gray-200 flex items-center gap-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <line x1="3" y1="9" x2="21" y2="9" />
                    <line x1="9" y1="21" x2="9" y2="9" />
                  </svg>
                  <span class="text-[10px] font-semibold text-gray-700 uppercase">Checkpoints</span>
                </div>
                <div class="flex-1 flex flex-col gap-1 p-1.5 overflow-y-auto" id="checkpoint-list">
                  <div class="flex flex-col items-center justify-center py-4 text-gray-400">
                    <div class="w-4 h-4 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"></div>
                    <span class="mt-1 text-[10px]">Loading...</span>
                  </div>
                </div>
              </aside>

              <!-- Resize handle for sidebar -->
              <div id="sidebar-resize-handle" class="w-1 bg-transparent hover:bg-yellow-400 cursor-col-resize transition-colors flex-shrink-0" title="Drag to resize"></div>

              <!-- Graph Container -->
              <div class="flex-1 flex flex-col relative min-h-0" id="graph-container">
                <div class="px-3 py-1.5 text-[10px] text-gray-500 border-b border-gray-200 bg-white/80" id="graph-stats">Loading...</div>

                <div id="graph-canvas" class="flex-1 w-full h-full min-h-[400px]" style="background: #FAFAFA;"></div>

                <div class="absolute inset-0 flex flex-col items-center justify-center bg-white/95" id="graph-loading">
                  <div class="w-6 h-6 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                  <span class="mt-2 text-xs text-gray-500">Loading graph...</span>
                </div>
              </div>
            </div>

            <div class="legend-panel absolute bottom-16 right-4 w-48 bg-white/95 backdrop-blur-sm border border-gray-200 rounded-lg shadow-lg p-3 z-10" id="legend-panel">
              <button class="absolute top-2 right-2 p-1 rounded hover:bg-mama-lavender-light transition-colors" onclick="toggleLegend()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
              <h4 class="text-xs font-semibold text-gray-700 text-gray-700 flex items-center gap-1.5 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="16" x2="12" y2="12" />
                  <line x1="12" y1="8" x2="12.01" y2="8" />
                </svg>
                Legend
              </h4>
              <div class="legend-content space-y-3">
                <div>
                  <div class="text-[10px] font-semibold text-gray-600 uppercase tracking-wide mb-1.5">Edge Types</div>
                  <div class="flex items-center gap-2 text-xs text-gray-700 mb-1">
                    <span class="w-6 h-0.5" style="background: #666666;"></span>
                    <span>supersedes</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-700 mb-1">
                    <span class="w-6 h-0.5" style="background: #B8860B; border-bottom: 2px dashed #B8860B;"></span>
                    <span>builds_on</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-700 mb-1">
                    <span class="w-6 h-0.5" style="background: #DC143C; border-bottom: 2px dashed #DC143C;"></span>
                    <span>debates</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-700">
                    <span class="w-6 h-1" style="background: #6B4C9A;"></span>
                    <span>synthesizes</span>
                  </div>
                </div>
                <div>
                  <div class="text-[10px] font-semibold text-gray-500 text-gray-600 uppercase tracking-wide mb-1.5">Node Size</div>
                  <div class="flex items-center gap-2 text-xs text-gray-600 text-gray-600 mb-1">
                    <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                    <span>1-2 connections</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-600 text-gray-600 mb-1">
                    <span class="w-3 h-3 rounded-full bg-indigo-500"></span>
                    <span>3-5 connections</span>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-gray-600 text-gray-600">
                    <span class="w-4 h-4 rounded-full bg-indigo-500"></span>
                    <span>6+ connections</span>
                  </div>
                </div>
              </div>
            </div>
            <button class="legend-toggle absolute bottom-4 right-4 px-3 py-1.5 text-xs font-medium bg-gray-100 bg-white hover:bg-gray-200 hover:bg-mama-lavender border border-gray-200 border-mama-lavender-dark rounded-lg transition-colors flex items-center gap-1.5 z-10" onclick="toggleLegend()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
              </svg>
              Legend
            </button>
          </div>
        </div>

        <div class="floating-panel fixed w-[360px] min-w-[280px] max-w-[90vw] h-[400px] min-h-[200px] max-h-[80vh] bg-white/95 backdrop-blur-sm border border-gray-200 rounded-xl shadow-2xl z-[1000] flex-col overflow-hidden resize" id="decision-detail-modal" style="top: 100px; right: 20px; left: auto; transform: none;">
          <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 bg-gray-50/80 cursor-move select-none" id="detail-modal-header">
            <h3 class="text-sm font-semibold text-gray-900 truncate flex-1" id="detail-topic">Decision Detail</h3>
            <button class="p-1 rounded hover:bg-gray-200 transition-colors text-gray-500 hover:text-gray-700 ml-2" onclick="closeDetailModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div class="flex-1 p-3 overflow-y-auto space-y-3 text-xs">
            <div>
              <div class="font-semibold text-gray-500 uppercase tracking-wide mb-1">Decision</div>
              <div class="text-gray-900 leading-relaxed markdown-content" id="detail-decision"></div>
            </div>
            <div>
              <div class="font-semibold text-gray-500 uppercase tracking-wide mb-1 cursor-pointer hover:text-gray-700" onclick="toggleReasoning()">
                <span id="reasoning-arrow">‚ñ∂</span> Reasoning
              </div>
              <div class="text-gray-900 leading-relaxed markdown-content hidden" id="detail-reasoning"></div>
            </div>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <span class="font-semibold text-gray-500 uppercase">Outcome:</span>
                <select class="px-1.5 py-0.5 bg-white border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-yellow-400" id="detail-outcome-select">
                  <option value="PENDING">PENDING</option>
                  <option value="SUCCESS">SUCCESS</option>
                  <option value="FAILED">FAILED</option>
                  <option value="PARTIAL">PARTIAL</option>
                </select>
                <button class="px-1.5 py-0.5 bg-gray-100 hover:bg-gray-200 rounded transition-colors" onclick="saveOutcome()">Save</button>
                <span id="outcome-status"></span>
              </div>
            </div>
            <div class="flex gap-4">
              <div>
                <span class="font-semibold text-gray-500 uppercase">Confidence:</span>
                <span class="text-gray-900" id="detail-confidence"></span>
              </div>
              <div>
                <span class="font-semibold text-gray-500 uppercase">Created:</span>
                <span class="text-gray-900" id="detail-created"></span>
              </div>
            </div>
            <div>
              <div class="font-semibold text-gray-500 uppercase tracking-wide mb-1">Similar Decisions</div>
              <div class="text-gray-900" id="detail-similar">
                <span class="text-gray-400">Searching...</span>
              </div>
            </div>
          </div>
          <div id="decision-resize-handle" class="decision-resize-handle" aria-label="Resize decision modal"></div>
        </div>

        <!-- Skills Marketplace Tab -->
        <div class="tab-content" id="tab-skills">
          <div class="flex-1 flex flex-col w-full max-w-6xl mx-auto p-4 h-full overflow-y-auto">
            <!-- Search Bar -->
            <div class="mb-4">
              <input id="skills-search" type="text"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-yellow-500"
                placeholder="Search skills...">
            </div>

            <!-- URL Install -->
            <div class="flex gap-2 mb-4">
              <input id="skills-url-input" type="text"
                class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                placeholder="https://github.com/owner/repo">
              <button id="skills-url-install-btn"
                class="px-4 py-1.5 text-xs rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700 whitespace-nowrap">
                Install URL
              </button>
            </div>

            <!-- Filter Bar -->
            <div id="skills-filter-bar" class="flex gap-2 mb-4 flex-wrap">
              <button data-filter="all" class="px-3 py-1 text-xs rounded-full bg-yellow-400 text-gray-900 font-medium">All</button>
              <button data-filter="installed" class="px-3 py-1 text-xs rounded-full bg-gray-700 text-gray-300">Installed</button>
              <button data-filter="mama" class="px-3 py-1 text-xs rounded-full bg-gray-700 text-gray-300">MAMA</button>
              <button data-filter="cowork" class="px-3 py-1 text-xs rounded-full bg-gray-700 text-gray-300">Cowork</button>
              <button data-filter="external" class="px-3 py-1 text-xs rounded-full bg-gray-700 text-gray-300">External</button>
            </div>

            <!-- Skills Content (rendered by skills.js) -->
            <div id="skills-content">
              <div class="flex items-center justify-center p-12 text-gray-500">
                <p class="text-sm">Loading skills...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Skill Detail Modal -->
        <div id="skill-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl mx-4">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
              <h2 class="text-lg font-bold text-white">Skill Details</h2>
              <button onclick="window.skillsModule && window.skillsModule.closeDetail()"
                class="text-gray-400 hover:text-white text-xl leading-none">&times;</button>
            </div>
            <div id="skill-detail-content" class="p-4 overflow-y-auto flex-1 text-sm text-gray-300">
            </div>
          </div>
        </div>

        <!-- Floating Chat (global, visible on all tabs) -->
        <div id="floating-chat" class="fixed bottom-6 right-6 z-50">
          <button id="chat-bubble"
            class="w-14 h-14 rounded-full bg-mama-yellow shadow-yellow flex items-center justify-center hover:scale-110 transition-transform cursor-pointer relative"
            title="Open Chat">
            <svg class="w-6 h-6 text-mama-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span id="chat-badge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
          </button>

          <div id="chat-panel" class="chat-panel-closed absolute bottom-[4.5rem] right-0 w-[400px] h-[560px] bg-white rounded-2xl shadow-float border border-mama-lavender-dark flex flex-col overflow-hidden">
            <!-- Header -->
            <div id="chat-header" class="h-12 bg-mama-yellow/20 flex items-center px-4 border-b border-mama-lavender-dark shrink-0">
              <svg class="w-5 h-5 text-mama-black mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="font-bold text-mama-black text-sm">MAMA Chat</span>
              <div class="ml-2 flex items-center gap-1 text-xs text-gray-500" id="chat-status">
                <span class="status-indicator w-2 h-2 rounded-full bg-red-500"></span>
                <span>Not connected</span>
              </div>
              <div class="ml-auto flex items-center gap-1">
                <button class="p-1.5 rounded-lg hover:bg-mama-lavender-light transition-colors" id="chat-tts-toggle" onclick="toggleTTS()" title="TTS Off">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="relative">
                  <span class="text-[10px] text-gray-500 cursor-pointer px-1 py-0.5 hover:bg-mama-lavender-light rounded" id="tts-speed-label" onclick="toggleTTSPopup()">1.8x</span>
                  <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-white border border-mama-lavender-dark rounded-lg p-3 shadow-lg hidden" id="tts-speed-popup">
                    <div class="text-center text-sm font-semibold mb-2" id="tts-speed-value">1.8x</div>
                    <input type="range" class="w-full accent-mama-yellow" id="tts-speed-slider" min="0.5" max="2.0" step="0.1" value="1.8" oninput="updateTTSSpeed(this.value)" />
                  </div>
                </div>
                <button class="p-1.5 rounded-lg hover:bg-mama-lavender-light transition-colors" id="chat-handsfree-toggle" onclick="toggleHandsFree()" title="Hands-free Off">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="2" stroke-width="2"/>
                    <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button id="chat-close" class="p-1.5 rounded-lg hover:bg-red-100 transition-colors text-gray-500 hover:text-red-600" title="Close">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18" stroke-width="2" stroke-linecap="round"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto p-3 flex flex-col gap-3 min-h-0" id="chat-messages">
              <div class="flex-1 flex flex-col items-center justify-center text-center p-6 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-3 opacity-50">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                <p class="text-sm">Start a conversation</p>
              </div>
            </div>

            <!-- Input -->
            <div class="border-t border-mama-lavender-dark p-3 space-y-2 shrink-0">
              <div class="flex gap-2">
                <textarea
                  class="flex-1 px-3 py-2 border border-mama-lavender-dark rounded-lg bg-mama-lavender-light text-mama-black placeholder-gray-500 resize-none focus:outline-none focus:ring-2 focus:ring-mama-yellow disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                  id="chat-input" placeholder="Type your message..." rows="1" disabled
                ></textarea>
                <button
                  class="px-3 py-2 bg-mama-yellow hover:bg-mama-yellow-hover disabled:bg-gray-400 text-mama-black rounded-lg font-medium transition-colors disabled:cursor-not-allowed flex items-center"
                  id="chat-send" onclick="sendChatMessage()" disabled>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <line x1="22" y1="2" x2="11" y2="13" stroke-width="2" stroke-linecap="round"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <!-- Attachment preview -->
              <div id="chat-attachment-preview" class="hidden flex items-center gap-2 px-2 py-1 bg-mama-lavender-light rounded-lg border border-mama-lavender-dark">
                <img id="chat-attachment-thumb" class="w-10 h-10 object-cover rounded" src="" alt="preview" />
                <span id="chat-attachment-name" class="text-xs text-gray-600 truncate max-w-[120px]"></span>
                <button class="text-gray-400 hover:text-red-500 ml-auto" onclick="clearAttachment()" title="Remove">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18" stroke-width="2" stroke-linecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
              </div>
              <div class="flex items-center gap-1">
                <input type="file" id="chat-file-input" class="hidden" accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xls,.xlsx" onchange="handleFileSelect(event)" />
                <button class="p-1.5 rounded-lg hover:bg-mama-lavender-light transition-colors" id="chat-attach" onclick="document.getElementById('chat-file-input').click()" title="Attach file">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="p-1.5 rounded-lg hover:bg-mama-lavender-light transition-colors relative" id="chat-mic" onclick="toggleVoiceInput()" title="Voice input">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="19" x2="12" y2="22" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <span class="recording-dot absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                <span class="text-[10px] text-gray-400 ml-1">Enter to send, Shift+Enter for new line</span>
              </div>
            </div>
            <div id="chat-resize-handle" class="chat-resize-handle" aria-label="Resize chat panel"></div>
          </div>
        </div>
      </main>

      <div class="modal-overlay fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center" id="save-decision-modal">
        <div class="bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-xl shadow-2xl w-[90%] max-w-md max-h-[90vh] flex flex-col overflow-hidden">
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 border-mama-lavender-dark bg-gray-50 bg-mama-lavender-light/50">
            <h3 class="flex items-center gap-2 text-base font-semibold text-gray-900 text-mama-black">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
              </svg>
              Save Decision
            </h3>
            <button class="p-1.5 rounded-lg hover:bg-gray-200 hover:bg-mama-lavender transition-colors text-gray-500 hover:text-gray-700 hover:text-mama-black" onclick="hideSaveDecisionForm()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
          <div class="p-4 space-y-4">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-900 text-mama-black" for="save-topic">Topic</label>
              <input
                type="text"
                class="w-full px-3 py-2 bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-lg text-sm text-gray-900 text-mama-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-mama-yellow transition-colors"
                id="save-topic"
                placeholder="e.g., auth_strategy"
                required
              />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-900 text-mama-black" for="save-decision">Decision</label>
              <textarea
                class="w-full px-3 py-2 bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-lg text-sm text-gray-900 text-mama-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-mama-yellow transition-colors resize-y min-h-[60px]"
                id="save-decision"
                placeholder="What did you decide?"
                rows="2"
                required
              ></textarea>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-900 text-mama-black" for="save-reasoning">Reasoning</label>
              <textarea
                class="w-full px-3 py-2 bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-lg text-sm text-gray-900 text-mama-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-mama-yellow transition-colors resize-y min-h-[100px]"
                id="save-reasoning"
                placeholder="Why did you make this decision?"
                rows="4"
                required
              ></textarea>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-900 text-mama-black" for="save-confidence">Confidence (0.0 - 1.0)</label>
              <input
                type="number"
                class="w-28 px-3 py-2 bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-lg text-sm text-gray-900 text-mama-black focus:outline-none focus:ring-2 focus:ring-mama-yellow transition-colors"
                id="save-confidence"
                min="0"
                max="1"
                step="0.1"
                value="0.8"
              />
            </div>
          </div>
          <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200 border-mama-lavender-dark bg-gray-50 bg-mama-lavender-light/50">
            <button class="px-4 py-2 text-sm font-medium text-gray-700 text-gray-700 bg-gray-100 bg-white hover:bg-gray-200 hover:bg-mama-lavender rounded-lg transition-colors" onclick="hideSaveDecisionForm()">Cancel</button>
            <button
              class="px-4 py-2 text-sm font-medium text-white bg-mama-yellow hover:bg-mama-yellow-hover rounded-lg transition-colors"
              id="save-form-submit"
              onclick="submitSaveDecision()"
            >Save</button>
          </div>
          <div id="save-form-status" class="px-5 pb-4 text-center text-sm"></div>
        </div>
      </div>

      <div class="modal-overlay fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center" id="tunnel-setup-modal">
        <div class="bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded-xl shadow-2xl w-[90%] max-w-[600px] max-h-[90vh] flex flex-col overflow-hidden">
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 border-mama-lavender-dark bg-gray-50 bg-mama-lavender-light/50">
            <h3 class="flex items-center gap-2 text-base font-semibold text-gray-900 text-mama-black">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="2" y1="12" x2="22" y2="12" />
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
              </svg>
              External Access Setup
            </h3>
            <button class="p-1.5 rounded-lg hover:bg-gray-200 hover:bg-mama-lavender transition-colors text-gray-500 hover:text-gray-700 hover:text-mama-black" onclick="hideTunnelSetup()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
          <div class="flex-1 p-4 overflow-y-auto space-y-4">
            <!-- ngrok section -->
            <div class="bg-gray-100 bg-white border border-gray-200 border-mama-lavender-dark rounded-lg p-4">
              <h4 class="text-sm text-mama-black text-mama-black mb-2 flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                </svg>
                ngrok (Quick Setup)
              </h4>
              <p class="text-xs text-gray-500 text-gray-600 mb-3">Tunnel your local server to a public URL</p>
              <div class="bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded px-3 py-2 flex items-center justify-between gap-2 mb-2">
                <code id="ngrok-command" class="font-mono text-sm text-green-600 text-green-600">ngrok http 3847</code>
                <button class="p-1.5 rounded hover:bg-mama-lavender-light transition-colors" onclick="copyNgrokCommand()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                  </svg>
                </button>
              </div>
              <a href="https://ngrok.com/download" target="_blank" rel="noopener noreferrer" class="text-xs text-mama-black text-mama-black hover:underline flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download ngrok
              </a>
            </div>

            <!-- Cloudflare section -->
            <div class="bg-gray-100 bg-white border border-gray-200 border-mama-lavender-dark rounded-lg p-4">
              <h4 class="text-sm text-mama-black text-mama-black mb-2 flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" />
                </svg>
                Cloudflare Tunnel (Production)
              </h4>
              <p class="text-xs text-gray-500 text-gray-600 mb-2">Secure tunnel with custom domain support</p>
              <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/" target="_blank" rel="noopener noreferrer" class="text-xs text-mama-black text-mama-black hover:underline flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
                Setup Guide
              </a>
            </div>

            <!-- Security warning -->
            <div class="bg-amber-50 bg-amber-100/20 border border-amber-200 border-amber-300/50 rounded-lg p-3 flex gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500 flex-shrink-0 mt-0.5">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
              <div class="text-xs">
                <strong class="text-amber-600 text-amber-600 block mb-1">Security Notice</strong>
                <span class="text-gray-700 text-gray-700">Always set MAMA_AUTH_TOKEN environment variable before exposing your server externally.</span>
                <pre class="bg-white bg-mama-lavender-light border border-gray-200 border-mama-lavender-dark rounded px-2 py-1.5 mt-2 text-[11px] text-green-600 text-green-600 overflow-x-auto">export MAMA_AUTH_TOKEN="your-secure-token-here"</pre>
              </div>
            </div>

            <!-- Test connection -->
            <div class="border-t border-gray-200 border-mama-lavender-dark pt-4">
              <button class="w-full px-4 py-2 text-sm font-medium text-white bg-mama-yellow hover:bg-mama-yellow-hover rounded-lg transition-colors flex items-center justify-center gap-2" onclick="testConnection()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M5 12.55a11 11 0 0 1 14.08 0" />
                  <path d="M1.42 9a16 16 0 0 1 21.16 0" />
                  <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
                  <line x1="12" y1="20" x2="12.01" y2="20" />
                </svg>
                Test Connection
              </button>
              <div id="tunnel-test-result" class="mt-3 min-h-[40px]"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="toast" id="toast">
        <span id="toast-message"></span>
      </div>
    </div>

    <script type="module">
      import { ChatModule } from '/viewer/js/modules/chat.js';
      import { GraphModule } from '/viewer/js/modules/graph.js';
      import { MemoryModule } from '/viewer/js/modules/memory.js';
      import { DashboardModule } from '/viewer/js/modules/dashboard.js';
      import { SettingsModule } from '/viewer/js/modules/settings.js';
      import { SkillsModule } from '/viewer/js/modules/skills.js';
      import { API } from '/viewer/js/utils/api.js';

      const memory = new MemoryModule();
      const chat = new ChatModule(memory);
      const graph = new GraphModule();
      const dashboard = new DashboardModule();
      const settings = new SettingsModule();
      const skills = SkillsModule;

      // Expose modules globally for debugging and onclick handlers
      window.chatModule = chat;
      window.graphModule = graph;
      window.memoryModule = memory;
      window.dashboardModule = dashboard;
      window.settingsModule = settings;
      window.skillsModule = skills;

      // Quiz choice button handler
      window.sendQuizChoice = (choice) => {
        chat.sendQuizChoice(choice);
      };

      const STATE = {
        currentTab: 'dashboard',
        theme: 'dark',
        graphLoaded: false
      };

      async function switchTab(tabName) {
        STATE.currentTab = tabName;

        document.querySelectorAll('[data-tab]').forEach(btn => {
          const isActive = btn.dataset.tab === tabName;
          btn.classList.toggle('bg-indigo-100', isActive);
          btn.classList.toggle('bg-mama-lavender/30', isActive);
          btn.classList.toggle('text-mama-black', isActive);
          btn.classList.toggle('text-mama-black', isActive);
        });

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.id === `tab-${tabName}`);
        });

        if (tabName === 'dashboard') {
          dashboard.init();
        } else if (tabName === 'settings') {
          settings.init();
        } else if (tabName === 'skills') {
          skills.init();
        } else if (tabName === 'memory') {
          // Initialize sidebar state for current screen size
          updateCheckpointSidebarForScreenSize();

          // Load checkpoints
          loadCheckpoints();

          // Load memory stats for analytics bar
          updateMemoryStats();

          // Load graph
          if (!STATE.graphLoaded) {
            try {
              const data = await graph.fetchData();
              graph.init(data);
              STATE.graphLoaded = true;
              const loadingEl = document.getElementById('graph-loading');
              if (loadingEl) loadingEl.style.display = 'none';
            } catch (error) {
              console.error('[MAMA] Failed to load graph:', error);
              const loadingEl = document.getElementById('graph-loading');
              if (loadingEl) loadingEl.innerHTML = '<span class="text-red-500">Failed to load graph data</span>';
            }
          }
        }
      }

      function toggleTheme() {
        // Light-only theme (brand unification) - no toggle needed
      }

      function initTheme() {
        // Light-only theme (brand unification)
        STATE.theme = 'light';
      }

      function toggleLegend() {
        const panel = document.getElementById('legend-panel');
        panel.classList.toggle('visible');
      }

      function closeDetailModal() {
        const modal = document.getElementById('decision-detail-modal');
        modal.classList.remove('visible');
      }

      // Draggable modal functionality
      (function initDraggableModal() {
        const modal = document.getElementById('decision-detail-modal');
        const header = document.getElementById('detail-modal-header');
        const resizeHandle = document.getElementById('decision-resize-handle');
        if (!modal || !header) return;

        let isDragging = false;
        let startX, startY, startLeft, startTop;

        header.addEventListener('mousedown', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          const rect = modal.getBoundingClientRect();
          startLeft = rect.left;
          startTop = rect.top;
          modal.style.transition = 'none';
          document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          modal.style.left = Math.max(0, Math.min(window.innerWidth - 100, startLeft + dx)) + 'px';
          modal.style.top = Math.max(0, Math.min(window.innerHeight - 50, startTop + dy)) + 'px';
          modal.style.right = 'auto';
          modal.style.transform = 'none';
        });

        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            document.body.style.userSelect = '';
          }
        });

        // Touch drag for mobile
        header.addEventListener('touchstart', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          const touch = e.touches[0];
          if (!touch) return;
          e.preventDefault();
          e.stopPropagation();
          document.body.classList.add('no-scroll');
          isDragging = true;
          startX = touch.clientX;
          startY = touch.clientY;
          const rect = modal.getBoundingClientRect();
          startLeft = rect.left;
          startTop = rect.top;
          modal.style.transition = 'none';
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          const touch = e.touches[0];
          if (!touch) return;
          e.preventDefault();
          e.stopPropagation();
          const dx = touch.clientX - startX;
          const dy = touch.clientY - startY;
          modal.style.left = Math.max(0, Math.min(window.innerWidth - 100, startLeft + dx)) + 'px';
          modal.style.top = Math.max(0, Math.min(window.innerHeight - 50, startTop + dy)) + 'px';
          modal.style.right = 'auto';
          modal.style.transform = 'none';
        }, { passive: false });

        document.addEventListener('touchend', () => {
          if (isDragging) {
            isDragging = false;
            document.body.classList.remove('no-scroll');
          }
        });

        // Resize (mouse + touch)
        if (resizeHandle) {
          let resizing = false;
          let rStartX, rStartY, rStartW, rStartH;

          const startResize = (clientX, clientY) => {
            resizing = true;
            rStartX = clientX;
            rStartY = clientY;
            rStartW = modal.offsetWidth;
            rStartH = modal.offsetHeight;
            document.body.style.userSelect = 'none';
          };

          const doResize = (clientX, clientY) => {
            if (!resizing) return;
            const dx = clientX - rStartX;
            const dy = clientY - rStartY;
            const minW = 280;
            const minH = 200;
            const maxW = Math.min(window.innerWidth * 0.95, 900);
            const maxH = Math.min(window.innerHeight * 0.9, 900);
            modal.style.width = Math.max(minW, Math.min(maxW, rStartW + dx)) + 'px';
            modal.style.height = Math.max(minH, Math.min(maxH, rStartH + dy)) + 'px';
          };

          const endResize = () => {
            if (!resizing) return;
            resizing = false;
            document.body.style.userSelect = '';
          };

          resizeHandle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startResize(e.clientX, e.clientY);
          });
          document.addEventListener('mousemove', (e) => doResize(e.clientX, e.clientY));
          document.addEventListener('mouseup', endResize);

          resizeHandle.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            if (!touch) return;
            e.preventDefault();
            e.stopPropagation();
            startResize(touch.clientX, touch.clientY);
            document.body.classList.add('no-scroll');
          }, { passive: false });
          document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            if (!touch) return;
            if (!resizing) return;
            e.preventDefault();
            e.stopPropagation();
            doResize(touch.clientX, touch.clientY);
          }, { passive: false });
          document.addEventListener('touchend', () => {
            endResize();
            document.body.classList.remove('no-scroll');
          });
        }
      })();

      function toggleReasoning() {
        const reasoning = document.getElementById('detail-reasoning');
        const arrow = document.getElementById('reasoning-arrow');
        if (reasoning.classList.contains('hidden')) {
          reasoning.classList.remove('hidden');
          arrow.textContent = '‚ñº';
        } else {
          reasoning.classList.add('hidden');
          arrow.textContent = '‚ñ∂';
        }
      }

      // Checkpoint sidebar toggle
      function toggleCheckpointSidebar() {
        const sidebar = document.getElementById('checkpoint-sidebar');
        const toggleBtn = document.getElementById('checkpoint-sidebar-toggle');
        const handle = document.getElementById('sidebar-resize-handle');

        if (!sidebar) return;

        const isExpanding = sidebar.classList.contains('collapsed');
        if (isExpanding) {
          sidebar.classList.remove('collapsed');
          sidebar.style.width = '224px'; // w-56 = 14rem = 224px
          if (toggleBtn) {
            toggleBtn.title = 'Hide Checkpoints';
            toggleBtn.setAttribute('aria-expanded', 'true');
          }
          if (handle) handle.style.display = '';
        } else {
          sidebar.classList.add('collapsed');
          sidebar.style.width = '0';
          if (toggleBtn) {
            toggleBtn.title = 'Show Checkpoints';
            toggleBtn.setAttribute('aria-expanded', 'false');
          }
          if (handle) handle.style.display = 'none';
        }
      }

      // Auto-collapse/expand checkpoint sidebar based on screen width
      function updateCheckpointSidebarForScreenSize() {
        const sidebar = document.getElementById('checkpoint-sidebar');
        const toggleBtn = document.getElementById('checkpoint-sidebar-toggle');
        const handle = document.getElementById('sidebar-resize-handle');
        if (!sidebar) return;

        if (window.innerWidth < 768) {
          // Mobile: stack layout with resizable height
          sidebar.classList.remove('collapsed');
          sidebar.style.width = '100%';
          sidebar.style.height = '30vh';
          if (handle) {
            handle.style.display = '';
            handle.classList.add('sidebar-resize-handle--row');
          }
          if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
        } else {
          // Desktop: expand if was collapsed due to mobile
          if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            sidebar.style.width = '224px';
          }
          sidebar.style.height = '';
          if (handle) {
            handle.style.display = '';
            handle.classList.remove('sidebar-resize-handle--row');
          }
          if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'true');
        }
      }

      // Initialize and listen for resize
      function initCheckpointSidebar() {
        updateCheckpointSidebarForScreenSize();
        window.addEventListener('resize', updateCheckpointSidebarForScreenSize);
      }

      // Expose to window for onclick handlers
      window.toggleCheckpointSidebar = toggleCheckpointSidebar;
      window.updateCheckpointSidebarForScreenSize = updateCheckpointSidebarForScreenSize;

      // Sidebar resize functionality
      (function initSidebarResize() {
        const handle = document.getElementById('sidebar-resize-handle');
        const sidebar = document.getElementById('checkpoint-sidebar');
        if (!handle || !sidebar) return;

        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        const isMobile = () => window.innerWidth < 768;

        handle.addEventListener('mousedown', (e) => {
          if (sidebar.classList.contains('collapsed')) return;
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = sidebar.offsetWidth;
          startHeight = sidebar.offsetHeight;
          document.body.style.cursor = isMobile() ? 'row-resize' : 'col-resize';
          document.body.style.userSelect = 'none';
          handle.style.background = '#FFCE00';
        });

        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          if (isMobile()) {
            const diff = e.clientY - startY;
            const newHeight = Math.max(140, Math.min(500, startHeight + diff));
            sidebar.style.height = newHeight + 'px';
          } else {
            const diff = e.clientX - startX;
            const newWidth = Math.max(120, Math.min(400, startWidth + diff));
            sidebar.style.width = newWidth + 'px';
          }
        });

        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            handle.style.background = '';
          }
        });

        // Touch support for mobile
        handle.addEventListener('touchstart', (e) => {
          if (sidebar.classList.contains('collapsed')) return;
          isResizing = true;
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          startWidth = sidebar.offsetWidth;
          startHeight = sidebar.offsetHeight;
          handle.style.background = '#FFCE00';
        });

        document.addEventListener('touchmove', (e) => {
          if (!isResizing) return;
          if (isMobile()) {
            const diff = e.touches[0].clientY - startY;
            const newHeight = Math.max(140, Math.min(500, startHeight + diff));
            sidebar.style.height = newHeight + 'px';
          } else {
            const diff = e.touches[0].clientX - startX;
            const newWidth = Math.max(120, Math.min(400, startWidth + diff));
            sidebar.style.width = newWidth + 'px';
          }
        });

        document.addEventListener('touchend', () => {
          if (isResizing) {
            isResizing = false;
            handle.style.background = '';
          }
        });
      })();

      // Initialize on load
      document.addEventListener('DOMContentLoaded', initCheckpointSidebar);

      function showTunnelSetup() {
        const modal = document.getElementById('tunnel-setup-modal');
        modal.classList.add('visible');
      }

      function hideTunnelSetup() {
        const modal = document.getElementById('tunnel-setup-modal');
        modal.classList.remove('visible');
      }

      function showSaveDecisionForm() {
        memory.showSaveForm();
      }

      function hideSaveDecisionForm() {
        memory.hideSaveForm();
      }

      function submitSaveDecision() {
        memory.submitSaveForm();
      }

      function copyNgrokCommand() {
        const cmd = document.getElementById('ngrok-command').textContent;
        navigator.clipboard.writeText(cmd);
        alert('Copied: ' + cmd);
      }

      function testConnection() {
        const result = document.getElementById('tunnel-test-result');
        result.innerHTML = '<span class="text-gray-500">Testing...</span>';
        fetch('/health')
          .then(r => r.ok ? result.innerHTML = '<span class="text-green-500">Connection OK</span>'
            : result.innerHTML = '<span class="text-red-500">Connection failed</span>')
          .catch(() => result.innerHTML = '<span class="text-red-500">Connection failed</span>');
      }

      async function sendChatMessage() {
        if (pendingAttachment) {
          const file = pendingAttachment;
          // Don't clear attachment yet - wait for successful send

          const formData = new FormData();
          formData.append('file', file);

          try {
            const resp = await fetch('/api/upload', { method: 'POST', body: formData });
            if (!resp.ok) throw new Error('Upload failed');
            const data = await resp.json();

            // Check WS connection before sending
            if (!chat.ws || chat.ws.readyState !== WebSocket.OPEN) {
              chat.addSystemMessage('Not connected. Please wait for reconnection.', 'error');
              return;
            }

            const input = document.getElementById('chat-input');
            const isImage = file.type.startsWith('image/');
            const defaultMsg = isImage ? 'What is in this image?' : 'Analyze this document';
            const message = input.value.trim() || defaultMsg;

            const mediaUrl = '/api/media/' + encodeURIComponent(data.filename);
            const attachMeta = { mediaUrl, filename: data.filename, originalName: file.name, contentType: file.type, isImage };

            // Save with attachment metadata for history persistence
            chat.addUserMessageWithAttachment(message, attachMeta);

            chat.enableSend(false);
            chat.ws.send(JSON.stringify({
              type: 'send',
              sessionId: chat.sessionId,
              content: message,
              attachments: [{
                filename: data.filename,
                contentType: data.contentType,
              }],
            }));

            // Clear attachment only after successful send
            clearAttachment();
            input.value = '';
          } catch (err) {
            chat.addSystemMessage('Upload failed: ' + err.message, 'error');
            // Keep pendingAttachment so user can retry
          }
          return;
        }
        chat.send();
      }

      // Send quiz choice as message
      window.sendQuizChoice = function(choice) {
        if (chat && chat.ws && chat.ws.readyState === WebSocket.OPEN) {
          // Set the input to the choice and send
          const input = document.getElementById('chat-input');
          if (input) {
            input.value = choice;
            chat.send();
          }
        }
      };

      function toggleTTS() {
        chat.toggleTTS && chat.toggleTTS();
      }

      function toggleTTSPopup() {
        const popup = document.getElementById('tts-speed-popup');
        popup.classList.toggle('hidden');
      }

      function updateTTSSpeed(value) {
        document.getElementById('tts-speed-label').textContent = value + 'x';
        document.getElementById('tts-speed-value').textContent = value + 'x';
        chat.setTTSRate && chat.setTTSRate(parseFloat(value));
      }

      function toggleHandsFree() {
        chat.toggleHandsFree && chat.toggleHandsFree();
      }

      function toggleVoiceInput() {
        chat.toggleVoice && chat.toggleVoice();
      }

      function filterByTopic(topic) {
        graph.filterByTopic && graph.filterByTopic(topic);
      }

      function filterByOutcome(outcome) {
        graph.filterByOutcome && graph.filterByOutcome(outcome);
      }

      function clearFilters() {
        document.getElementById('topic-filter').value = '';
        document.getElementById('outcome-filter').value = '';
        document.getElementById('search-input').value = '';
        graph.clearFilters && graph.clearFilters();
      }

      async function exportDecisions(format) {
        try {
          const response = await fetch(`/api/memory/export?format=${format}`);
          if (!response.ok) throw new Error('Export failed');

          const blob = await response.blob();
          const filename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1]
            || `mama-export.${format}`;

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('[Export] Error:', error);
          alert('Export failed: ' + error.message);
        }
      }

      async function updateMemoryStats() {
        try {
          const data = await API.get('/api/dashboard/status');
          const memory = data.memory || {};

          document.querySelector('#memory-stats-total p').textContent = memory.total || 0;
          document.querySelector('#memory-stats-week p').textContent = memory.thisWeek || 0;
          document.getElementById('outcome-success').textContent = memory.outcomes?.success || 0;
          document.getElementById('outcome-failed').textContent = memory.outcomes?.failed || 0;
          document.getElementById('outcome-partial').textContent = memory.outcomes?.partial || 0;
        } catch (error) {
          console.error('[MemoryStats] Error:', error);
        }
      }

      function handleGraphSearch(event) {
        if (event.key === 'Enter') {
          graph.search && graph.search();
        }
      }

      function saveOutcome() {
        const select = document.getElementById('detail-outcome-select');
        const outcome = select.value;
        const nodeId = graph.currentNodeId;
        if (nodeId && outcome) {
          graph.updateOutcome && graph.updateOutcome(nodeId, outcome);
        }
      }

      let checkpointsData = [];

      function renderMarkdown(text) {
        if (!text) return '';
        try {
          if (typeof marked !== 'undefined' && marked.parse) {
            return marked.parse(text);
          }
        } catch (e) {
          console.error('[MAMA] Markdown parse error:', e);
        }
        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
      }

      async function loadCheckpoints() {
        const container = document.getElementById('checkpoint-list');
        if (!container) {
          console.error('[MAMA] checkpoint-list container not found');
          return;
        }

        console.log('[MAMA] Loading checkpoints...');

        try {
          const data = await API.get('/api/checkpoints');
          checkpointsData = data.checkpoints || [];

          console.log('[MAMA] Loaded', checkpointsData.length, 'checkpoints');

          if (checkpointsData.length > 0) {
            container.innerHTML = checkpointsData.map((cp, idx) => {
              const fullSummary = renderMarkdown(cp.summary || '');
              return `
              <div class="checkpoint-item p-3 bg-white bg-white border border-gray-200 border-mama-lavender-dark rounded-lg cursor-pointer hover:border-indigo-500 transition-colors" onclick="toggleCheckpoint(${idx})">
                <div class="text-xs font-semibold text-mama-black text-mama-black mb-1">${new Date(cp.timestamp).toLocaleString()}</div>
                <div class="checkpoint-summary text-sm text-gray-700 text-gray-700 markdown-content line-clamp-3 overflow-hidden">${fullSummary}</div>
                <div class="checkpoint-details hidden mt-3 pt-3 border-t border-gray-200 border-mama-lavender-dark">
                  <div class="text-sm text-gray-700 text-gray-700 markdown-content max-h-64 overflow-y-auto">${fullSummary}</div>
                </div>
              </div>
            `}).join('');
          } else {
            container.innerHTML = '<div class="text-center text-sm text-gray-500 py-4">No checkpoints found</div>';
          }
        } catch (error) {
          console.error('[MAMA] Failed to load checkpoints:', error);
          container.innerHTML = '<div class="text-center text-sm text-red-500 py-4">Failed to load checkpoints</div>';
        }
      }

      function toggleCheckpoint(idx) {
        const items = document.querySelectorAll('.checkpoint-item');
        items.forEach((item, i) => {
          const details = item.querySelector('.checkpoint-details');
          const summary = item.querySelector('.checkpoint-summary');
          if (i === idx) {
            const isExpanded = !details.classList.contains('hidden');
            details.classList.toggle('hidden');
            summary.classList.toggle('hidden', !isExpanded);
            item.classList.toggle('border-indigo-500', !isExpanded);
          } else {
            details.classList.add('hidden');
            summary.classList.remove('hidden');
            item.classList.remove('border-indigo-500');
          }
        });
      }

      // Expose to window for onclick handlers
      window.switchTab = switchTab;
      window.toggleTheme = toggleTheme;
      window.toggleLegend = toggleLegend;
      window.closeDetailModal = closeDetailModal;
      window.toggleReasoning = toggleReasoning;
      window.showTunnelSetup = showTunnelSetup;
      window.hideTunnelSetup = hideTunnelSetup;
      window.showSaveDecisionForm = showSaveDecisionForm;
      window.hideSaveDecisionForm = hideSaveDecisionForm;
      window.submitSaveDecision = submitSaveDecision;
      window.copyNgrokCommand = copyNgrokCommand;
      window.testConnection = testConnection;
      window.sendChatMessage = sendChatMessage;
      window.toggleTTS = toggleTTS;
      window.toggleTTSPopup = toggleTTSPopup;
      window.updateTTSSpeed = updateTTSSpeed;
      window.toggleHandsFree = toggleHandsFree;
      window.toggleVoiceInput = toggleVoiceInput;

      // File attachment state
      let pendingAttachment = null;

      const FILE_ICONS = {
        'application/pdf': 'üìÑ',
        'text/plain': 'üìù',
        'text/csv': 'üìä',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'üìÉ',
        'application/msword': 'üìÉ',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'üìä',
        'application/vnd.ms-excel': 'üìä',
      };

      function getFileIcon(mimeType) {
        return FILE_ICONS[mimeType] || 'üìé';
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const preview = document.getElementById('chat-attachment-preview');
        const thumb = document.getElementById('chat-attachment-thumb');
        const name = document.getElementById('chat-attachment-name');

        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => { thumb.src = e.target.result; };
          reader.readAsDataURL(file);
          thumb.style.display = '';
        } else {
          // Show emoji icon for documents
          thumb.style.display = 'none';
          name.textContent = getFileIcon(file.type) + ' ' + file.name;
        }

        if (file.type.startsWith('image/')) {
          name.textContent = file.name;
        }
        preview.classList.remove('hidden');
        pendingAttachment = file;
        // cleared
      }

      function clearAttachment() {
        pendingAttachment = null;
        // cleared
        document.getElementById('chat-attachment-preview').classList.add('hidden');
        document.getElementById('chat-file-input').value = '';
        const thumb = document.getElementById('chat-attachment-thumb');
        thumb.src = '';
        thumb.style.display = '';
      }

      window.handleFileSelect = handleFileSelect;
      window.clearAttachment = clearAttachment;

      // Drag & drop support
      const chatMessages = document.getElementById('chat-messages');
      if (chatMessages) {
        const panel = chatMessages.closest('#chat-panel') || chatMessages.parentElement;
        ['dragenter', 'dragover'].forEach(evt => {
          panel.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); panel.classList.add('ring-2', 'ring-mama-yellow'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
          panel.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); panel.classList.remove('ring-2', 'ring-mama-yellow'); });
        });
        panel.addEventListener('drop', (e) => {
          const file = e.dataTransfer.files[0];
          if (!file) return;

          // Allowed MIME types and extensions (match file input accept attribute)
          const allowedTypes = ['image/', 'application/pdf', 'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'text/plain', 'text/csv', 'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
          const allowedExts = ['.pdf', '.doc', '.docx', '.txt', '.csv', '.xls', '.xlsx'];
          const ext = '.' + (file.name.split('.').pop() || '').toLowerCase();

          const isAllowed = allowedTypes.some(t => file.type.startsWith(t)) || allowedExts.includes(ext);
          if (isAllowed) {
            const dt = new DataTransfer();
            dt.items.add(file);
            document.getElementById('chat-file-input').files = dt.files;
            handleFileSelect({ target: { files: [file] } });
          } else {
            chat.addSystemMessage('Unsupported file type. Allowed: images, PDF, DOC, TXT, CSV, XLS', 'error');
          }
        });
      }

      window.filterByTopic = filterByTopic;
      window.handleGraphSearch = handleGraphSearch;
      window.saveOutcome = saveOutcome;
      window.loadCheckpoints = loadCheckpoints;
      window.toggleCheckpoint = toggleCheckpoint;

      document.addEventListener('DOMContentLoaded', () => {
        const userLang = navigator.language || navigator.userLanguage;
        document.documentElement.lang = userLang.split('-')[0];

        initTheme();
        // Initialize floating chat panel bindings (session init is lazy, on first open)
        chat.initFloating();
        // Default to dashboard tab
        switchTab('dashboard');
      });

      // Cleanup resources on page unload
      window.addEventListener('beforeunload', () => {
        // Cleanup dashboard intervals
        if (window.dashboardModule?.cleanup) {
          window.dashboardModule.cleanup();
        }
        // Cleanup chat resources
        if (window.chatModule?.cleanup) {
          window.chatModule.cleanup();
        }
        console.log('[MAMA] Resources cleaned up');
      });

      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/viewer/sw.js')
            .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
            .catch(err => console.warn('[PWA] Service Worker registration failed:', err));
        });
      }
    </script>

    <!-- Image Lightbox -->
    <div id="image-lightbox" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/80 backdrop-blur-sm cursor-pointer" onclick="closeLightbox()">
      <img id="lightbox-img" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl" onclick="event.stopPropagation()" />
      <button class="absolute top-4 right-4 text-white text-3xl font-bold hover:text-gray-300" onclick="closeLightbox()">&times;</button>
    </div>
    <script>
      function openLightbox(src) {
        const lb = document.getElementById('image-lightbox');
        document.getElementById('lightbox-img').src = src;
        lb.classList.remove('hidden');
        lb.classList.add('flex');
      }
      function closeLightbox() {
        const lb = document.getElementById('image-lightbox');
        lb.classList.add('hidden');
        lb.classList.remove('flex');
      }
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });
      // Event delegation for lightbox ‚Äî avoids inline onclick XSS
      document.addEventListener('click', e => {
        const el = e.target.closest('[data-lightbox]');
        if (el) { e.stopPropagation(); openLightbox(el.dataset.lightbox); }
      });
    </script>
  </body>
</html>
