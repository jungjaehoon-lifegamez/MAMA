<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAMA Mobile</title>

  <!-- PWA Meta Tags (manifest disabled due to Cloudflare Access CORS) -->
  <!-- <link rel="manifest" href="/viewer/manifest.json"> -->
  <meta name="theme-color" content="#1a1a2e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MAMA">
  <link rel="apple-touch-icon" href="/viewer/icons/icon-192.png">

  <script src="https://unpkg.com/vis-network@9/dist/vis-network.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="/viewer.css">
</head>
<body>
  <div id="app">
    <!-- Session Resume Banner -->
    <div id="session-resume-banner" class="session-resume-banner" style="display: none;">
      <div class="resume-content">
        <span class="resume-icon">ðŸ“–</span>
        <span class="resume-text">Previous session found</span>
      </div>
      <div class="resume-actions">
        <button class="resume-btn" onclick="window.chatModule.commandResume()">Resume</button>
        <button class="dismiss-btn" onclick="dismissResumeBanner()">Ã—</button>
      </div>
    </div>

    <header>
      <h1>MAMA Reasoning Graph</h1>
      <div class="controls">
        <select id="topic-filter" onchange="filterByTopic(this.value)">
          <option value="">All Topics</option>
        </select>
        <input type="text" id="search-input" placeholder="Search... (press /)"
               onkeyup="handleSearch(event)" style="display:none;">
      </div>
      <div class="stats" id="stats">Loading...</div>
    </header>
    <div id="graph-container">
      <div class="loading" id="loading">Loading graph data...</div>
    </div>
    <div id="detail-panel">
      <button class="close-btn" onclick="closeDetail()">&times;</button>
      <h3 id="detail-topic">Topic</h3>
      <div class="field">
        <div class="field-label">Decision</div>
        <div class="field-value" id="detail-decision"></div>
      </div>
      <div class="field">
        <div class="field-label reasoning-toggle" id="reasoning-toggle" onclick="toggleReasoning()">Reasoning</div>
        <div class="field-value reasoning-content" id="detail-reasoning"></div>
      </div>
      <div class="field">
        <div class="field-label">Similar Decisions</div>
        <div class="field-value similar-list" id="detail-similar">
          <span class="loading-similar">Searching...</span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">Outcome</div>
        <div class="field-value outcome-edit">
          <select id="detail-outcome-select">
            <option value="PENDING">PENDING</option>
            <option value="SUCCESS">SUCCESS</option>
            <option value="FAILED">FAILED</option>
            <option value="PARTIAL">PARTIAL</option>
          </select>
          <button onclick="saveOutcome()" class="save-btn">Save</button>
          <span id="outcome-status"></span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">Confidence</div>
        <div class="field-value" id="detail-confidence"></div>
      </div>
      <div class="field">
        <div class="field-label">Created</div>
        <div class="field-value" id="detail-created"></div>
      </div>
    </div>

    <!-- Sidebar Panel with Tabs -->
    <div id="sidebar-panel">
      <!-- Tab Header -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="checkpoints" onclick="switchTab('checkpoints')">
          <i data-lucide="clipboard-list"></i> Checkpoints
        </button>
        <button class="sidebar-tab" data-tab="chat" onclick="switchTab('chat')">
          <i data-lucide="message-circle"></i> Chat
        </button>
        <button class="sidebar-tab" data-tab="memory" onclick="switchTab('memory')">
          <i data-lucide="brain"></i> Memory
        </button>
        <button class="sidebar-close" onclick="toggleSidebar()"><i data-lucide="x"></i></button>
      </div>

      <!-- Checkpoints Tab Content -->
      <div class="tab-content active" id="tab-checkpoints">
        <div class="checkpoint-list" id="checkpoint-list">
          <div class="loading-checkpoints">Loading...</div>
        </div>
      </div>

      <!-- Chat Tab Content -->
      <div class="tab-content" id="tab-chat">
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <div class="chat-placeholder">
              <p><i data-lucide="message-circle"></i> Connect to a Claude session to start chatting</p>
              <p class="chat-hint">Create a session via REST API or use an existing one</p>
            </div>
          </div>
          <!-- 2-Row Layout for better mobile UX (Story 3.2) -->
          <div class="chat-input-container">
            <!-- Row 1: Textarea (expanded) -->
            <div class="chat-input-row">
              <textarea id="chat-input" placeholder="Type your message..." rows="3" disabled></textarea>
            </div>

            <!-- Row 2: All Controls -->
            <div class="chat-controls-row">
              <button id="chat-tts-toggle" class="chat-control-btn chat-tts-btn" onclick="toggleTTS()" title="TTS ë¹„í™œì„±í™”ë¨">
                <i data-lucide="volume-2"></i>
              </button>
              <span id="chat-tts-speed" class="tts-speed-label" title="Click to adjust TTS speed">
                1.8x
                <!-- TTS Speed Popup (minimal dropdown) -->
                <div id="tts-speed-popup" class="tts-speed-popup" style="display: none;">
                  <div class="tts-speed-value">1.8x</div>
                  <input type="range" id="tts-speed-slider" min="0.5" max="2.0" step="0.1" value="1.8">
                </div>
              </span>
              <button id="chat-handsfree-toggle" class="chat-control-btn chat-handsfree-btn" onclick="toggleHandsFree()" title="í•¸ì¦ˆí”„ë¦¬ ë¹„í™œì„±í™”ë¨">
                <i data-lucide="radio"></i>
              </button>
              <button id="chat-mic" class="chat-control-btn chat-mic-btn" onclick="toggleVoiceInput()" title="Voice input (Korean)">
                <i data-lucide="mic" class="mic-icon"></i>
                <span class="recording-dot"></span>
              </button>
              <button id="chat-send" class="chat-send-btn" onclick="sendChatMessage()" disabled>
                <i data-lucide="send"></i> Send
              </button>
            </div>
          </div>
          <div class="chat-status" id="chat-status">
            <span class="status-indicator disconnected"></span>
            <span>Not connected</span>
            <button class="tunnel-setup-btn" onclick="showTunnelSetup()" title="External Access Setup">
              <i data-lucide="globe"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Memory Tab Content (Story 4-1) -->
      <div class="tab-content" id="tab-memory">
        <div class="memory-container">
          <div class="memory-search">
            <input type="text" id="memory-search-input" placeholder="Search decisions..." onkeyup="handleMemorySearch(event)">
            <button class="memory-search-btn" onclick="searchMemoryDecisions()"><i data-lucide="search"></i></button>
            <button class="memory-save-btn" onclick="showSaveDecisionForm()" title="Save new decision"><i data-lucide="save"></i></button>
          </div>
          <div class="memory-results" id="memory-results">
            <div class="memory-placeholder">
              <p><i data-lucide="brain"></i> Search your MAMA decisions</p>
              <p class="memory-hint">Type a keyword or send a chat message to see related decisions</p>
            </div>
          </div>
          <div class="memory-status" id="memory-status"></div>
        </div>
      </div>
    </div>
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()"><i data-lucide="panel-left"></i> Sidebar</button>

    <!-- Save Decision Form Modal (Story 4-2) -->
    <div class="save-decision-modal" id="save-decision-modal">
      <div class="save-decision-form">
        <div class="save-form-header">
          <h3><i data-lucide="save"></i> Save Decision</h3>
          <button class="save-form-close" onclick="hideSaveDecisionForm()"><i data-lucide="x"></i></button>
        </div>
        <div class="save-form-body">
          <div class="save-form-field">
            <label for="save-topic">Topic</label>
            <input type="text" id="save-topic" placeholder="e.g., mobile_ui_design" required>
          </div>
          <div class="save-form-field">
            <label for="save-decision">Decision</label>
            <textarea id="save-decision" placeholder="What did you decide?" rows="2" required></textarea>
          </div>
          <div class="save-form-field">
            <label for="save-reasoning">Reasoning</label>
            <textarea id="save-reasoning" placeholder="Why did you make this decision?" rows="4" required></textarea>
          </div>
          <div class="save-form-field">
            <label for="save-confidence">Confidence (0.0 - 1.0)</label>
            <input type="number" id="save-confidence" min="0" max="1" step="0.1" value="0.8">
          </div>
        </div>
        <div class="save-form-footer">
          <button class="save-form-cancel" onclick="hideSaveDecisionForm()">Cancel</button>
          <button class="save-form-submit" onclick="submitSaveDecision()">Save</button>
        </div>
        <div class="save-form-status" id="save-form-status"></div>
      </div>
    </div>

    <!-- Tunnel Setup Modal (Story 5.2) -->
    <div class="tunnel-setup-modal" id="tunnel-setup-modal">
      <div class="tunnel-setup-form">
        <div class="tunnel-form-header">
          <h3><i data-lucide="globe"></i> External Access Setup</h3>
          <button class="tunnel-form-close" onclick="hideTunnelSetup()"><i data-lucide="x"></i></button>
        </div>
        <div class="tunnel-form-body">
          <!-- ngrok Section -->
          <div class="tunnel-section">
            <h4><i data-lucide="zap"></i> ngrok (Quick Setup)</h4>
            <p class="tunnel-description">Tunnel your local server to a public URL</p>
            <div class="tunnel-code">
              <code id="ngrok-command">ngrok http 3847</code>
              <button class="tunnel-copy-btn" onclick="copyNgrokCommand()" title="Copy command">
                <i data-lucide="copy"></i>
              </button>
            </div>
            <div class="tunnel-links">
              <a href="https://ngrok.com/download" target="_blank" rel="noopener noreferrer">
                <i data-lucide="download"></i> Download ngrok
              </a>
            </div>
          </div>

          <!-- Cloudflare Tunnel Section -->
          <div class="tunnel-section">
            <h4><i data-lucide="cloud"></i> Cloudflare Tunnel (Production)</h4>
            <p class="tunnel-description">Secure tunnel with custom domain support</p>
            <div class="tunnel-links">
              <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/" target="_blank" rel="noopener noreferrer">
                <i data-lucide="book-open"></i> Setup Guide
              </a>
            </div>
          </div>

          <!-- Auth Token Warning -->
          <div class="tunnel-warning">
            <i data-lucide="alert-triangle"></i>
            <div>
              <strong>Security Notice:</strong> Always set MAMA_AUTH_TOKEN environment variable before exposing your server externally.
              <pre>export MAMA_AUTH_TOKEN="your-secure-token-here"</pre>
            </div>
          </div>

          <!-- Connection Test -->
          <div class="tunnel-test">
            <button class="tunnel-test-btn" onclick="testConnection()">
              <i data-lucide="wifi"></i> Test Connection
            </button>
            <div class="tunnel-test-result" id="tunnel-test-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel">
      <button class="close-btn" onclick="toggleLegend()"><i data-lucide="x"></i></button>
      <h4><i data-lucide="info"></i> Legend</h4>
      <div class="legend-section">
        <div class="legend-section-title">Edge Types</div>
        <div class="legend-item">
          <span class="legend-edge solid" style="color: #848484;"></span>
          <span>supersedes</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge dashed" style="color: #457b9d;"></span>
          <span>builds_on</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge dashed" style="color: #e63946;"></span>
          <span>debates</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge solid thick" style="color: #9b59b6;"></span>
          <span>synthesizes</span>
        </div>
      </div>
      <div class="legend-section">
        <div class="legend-section-title">Node Size</div>
        <div class="legend-item">
          <span class="legend-node small" style="background: #6366f1;"></span>
          <span>1-2 connections</span>
        </div>
        <div class="legend-item">
          <span class="legend-node medium" style="background: #6366f1;"></span>
          <span>3-5 connections</span>
        </div>
        <div class="legend-item">
          <span class="legend-node large" style="background: #6366f1;"></span>
          <span>6+ connections</span>
        </div>
      </div>
    </div>
    <button class="legend-toggle" onclick="toggleLegend()"><i data-lucide="info"></i> Show Legend</button>
  </div>

  <script type="module" src="/viewer.js"></script>
  <script>
    // Lucide icon configuration (global)
    window.lucideConfig = {
      attrs: {
        width: 16,
        height: 16,
        'stroke-width': 1,
        'stroke-linecap': 'round',
        'stroke-linejoin': 'round',
        'vector-effect': 'non-scaling-stroke'
      }
    };

    // Initialize Lucide icons after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons(window.lucideConfig);

      // Re-initialize icons when detail panel updates (use MutationObserver)
      const detailPanel = document.getElementById('detail-panel');
      if (detailPanel) {
        const observer = new MutationObserver(() => {
          lucide.createIcons(window.lucideConfig);
        });
        observer.observe(detailPanel, { childList: true, subtree: true });
      }
    });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/viewer/sw.js')
          .then((registration) => {
            console.log('[PWA] Service Worker registered:', registration.scope);

            // Check for updates every hour
            setInterval(() => {
              registration.update();
            }, 60 * 60 * 1000);
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
