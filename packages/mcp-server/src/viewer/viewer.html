<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAMA Graph Viewer</title>
  <script src="https://unpkg.com/vis-network@9/dist/vis-network.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="/viewer.css">
</head>
<body>
  <div id="app">
    <header>
      <h1>MAMA Reasoning Graph</h1>
      <div class="controls">
        <select id="topic-filter" onchange="filterByTopic(this.value)">
          <option value="">All Topics</option>
        </select>
        <input type="text" id="search-input" placeholder="Search... (press /)"
               onkeyup="handleSearch(event)" style="display:none;">
      </div>
      <div class="stats" id="stats">Loading...</div>
    </header>
    <div id="graph-container">
      <div class="loading" id="loading">Loading graph data...</div>
    </div>
    <div id="detail-panel">
      <button class="close-btn" onclick="closeDetail()">&times;</button>
      <h3 id="detail-topic">Topic</h3>
      <div class="field">
        <div class="field-label">Decision</div>
        <div class="field-value" id="detail-decision"></div>
      </div>
      <div class="field">
        <div class="field-label reasoning-toggle" id="reasoning-toggle" onclick="toggleReasoning()">Reasoning</div>
        <div class="field-value reasoning-content" id="detail-reasoning"></div>
      </div>
      <div class="field">
        <div class="field-label">Similar Decisions</div>
        <div class="field-value similar-list" id="detail-similar">
          <span class="loading-similar">Searching...</span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">Outcome</div>
        <div class="field-value outcome-edit">
          <select id="detail-outcome-select">
            <option value="PENDING">PENDING</option>
            <option value="SUCCESS">SUCCESS</option>
            <option value="FAILED">FAILED</option>
            <option value="PARTIAL">PARTIAL</option>
          </select>
          <button onclick="saveOutcome()" class="save-btn">Save</button>
          <span id="outcome-status"></span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">Confidence</div>
        <div class="field-value" id="detail-confidence"></div>
      </div>
      <div class="field">
        <div class="field-label">Created</div>
        <div class="field-value" id="detail-created"></div>
      </div>
    </div>

    <!-- Sidebar Panel with Tabs -->
    <div id="sidebar-panel">
      <!-- Tab Header -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="checkpoints" onclick="switchTab('checkpoints')">
          üìã Checkpoints
        </button>
        <button class="sidebar-tab" data-tab="chat" onclick="switchTab('chat')">
          üí¨ Chat
        </button>
        <button class="sidebar-tab" data-tab="memory" onclick="switchTab('memory')">
          üß† Memory
        </button>
        <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
      </div>

      <!-- Checkpoints Tab Content -->
      <div class="tab-content active" id="tab-checkpoints">
        <div class="checkpoint-list" id="checkpoint-list">
          <div class="loading-checkpoints">Loading...</div>
        </div>
      </div>

      <!-- Chat Tab Content -->
      <div class="tab-content" id="tab-chat">
        <div class="chat-container">
          <div class="chat-messages" id="chat-messages">
            <div class="chat-placeholder">
              <p>üí¨ Connect to a Claude session to start chatting</p>
              <p class="chat-hint">Create a session via REST API or use an existing one</p>
            </div>
          </div>
          <div class="chat-input-area">
            <textarea id="chat-input" placeholder="Type your message..." rows="2" disabled></textarea>
            <button id="chat-mic" class="chat-mic-btn" onclick="toggleVoiceInput()" title="Voice input (Korean)">
              <span class="mic-icon">üé§</span>
              <span class="recording-dot"></span>
            </button>
            <button id="chat-send" class="chat-send-btn" onclick="sendChatMessage()" disabled>
              Send
            </button>
          </div>
          <div class="chat-status" id="chat-status">
            <span class="status-indicator disconnected"></span>
            <span>Not connected</span>
          </div>
        </div>
      </div>

      <!-- Memory Tab Content (Story 4-1) -->
      <div class="tab-content" id="tab-memory">
        <div class="memory-container">
          <div class="memory-search">
            <input type="text" id="memory-search-input" placeholder="Search decisions..." onkeyup="handleMemorySearch(event)">
            <button class="memory-search-btn" onclick="searchMemoryDecisions()">üîç</button>
            <button class="memory-save-btn" onclick="showSaveDecisionForm()" title="Save new decision">üíæ</button>
          </div>
          <div class="memory-results" id="memory-results">
            <div class="memory-placeholder">
              <p>üß† Search your MAMA decisions</p>
              <p class="memory-hint">Type a keyword or send a chat message to see related decisions</p>
            </div>
          </div>
          <div class="memory-status" id="memory-status"></div>
        </div>
      </div>
    </div>
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">üìã Sidebar</button>

    <!-- Save Decision Form Modal (Story 4-2) -->
    <div class="save-decision-modal" id="save-decision-modal">
      <div class="save-decision-form">
        <div class="save-form-header">
          <h3>üíæ Save Decision</h3>
          <button class="save-form-close" onclick="hideSaveDecisionForm()">&times;</button>
        </div>
        <div class="save-form-body">
          <div class="save-form-field">
            <label for="save-topic">Topic</label>
            <input type="text" id="save-topic" placeholder="e.g., mobile_ui_design" required>
          </div>
          <div class="save-form-field">
            <label for="save-decision">Decision</label>
            <textarea id="save-decision" placeholder="What did you decide?" rows="2" required></textarea>
          </div>
          <div class="save-form-field">
            <label for="save-reasoning">Reasoning</label>
            <textarea id="save-reasoning" placeholder="Why did you make this decision?" rows="4" required></textarea>
          </div>
          <div class="save-form-field">
            <label for="save-confidence">Confidence (0.0 - 1.0)</label>
            <input type="number" id="save-confidence" min="0" max="1" step="0.1" value="0.8">
          </div>
        </div>
        <div class="save-form-footer">
          <button class="save-form-cancel" onclick="hideSaveDecisionForm()">Cancel</button>
          <button class="save-form-submit" onclick="submitSaveDecision()">Save</button>
        </div>
        <div class="save-form-status" id="save-form-status"></div>
      </div>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel">
      <button class="close-btn" onclick="toggleLegend()" style="position:absolute;top:8px;right:8px;">&times;</button>
      <h4>Legend</h4>
      <div class="legend-section">
        <div class="legend-section-title">Edge Types</div>
        <div class="legend-item">
          <span class="legend-edge solid" style="color: #848484;"></span>
          <span>supersedes</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge dashed" style="color: #457b9d;"></span>
          <span>builds_on</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge dashed" style="color: #e63946;"></span>
          <span>debates</span>
        </div>
        <div class="legend-item">
          <span class="legend-edge solid thick" style="color: #9b59b6;"></span>
          <span>synthesizes</span>
        </div>
      </div>
      <div class="legend-section">
        <div class="legend-section-title">Node Size</div>
        <div class="legend-item">
          <span class="legend-node small" style="background: #6366f1;"></span>
          <span>1-2 connections</span>
        </div>
        <div class="legend-item">
          <span class="legend-node medium" style="background: #6366f1;"></span>
          <span>3-5 connections</span>
        </div>
        <div class="legend-item">
          <span class="legend-node large" style="background: #6366f1;"></span>
          <span>6+ connections</span>
        </div>
      </div>
    </div>
    <button class="legend-toggle" onclick="toggleLegend()">Show Legend</button>
  </div>

  <script type="module" src="/viewer.js"></script>
  <script>
    // Initialize Lucide icons after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();

      // Re-initialize icons when detail panel updates (use MutationObserver)
      const detailPanel = document.getElementById('detail-panel');
      if (detailPanel) {
        const observer = new MutationObserver(() => {
          lucide.createIcons();
        });
        observer.observe(detailPanel, { childList: true, subtree: true });
      }
    });
  </script>
</body>
</html>
