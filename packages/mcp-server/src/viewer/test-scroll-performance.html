<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Scroll Performance Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e0e0e0;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      background: #4a4a6a;
      color: #e0e0e0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #5a5a7a;
    }

    .metrics {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .metric {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .metric-label {
      font-size: 12px;
      color: #888;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: #a0a0ff;
    }

    .metric-value.good {
      color: #22c55e;
    }

    .metric-value.warning {
      color: #f59e0b;
    }

    .metric-value.bad {
      color: #ef4444;
    }

    .chat-messages {
      background: #16213e;
      border: 1px solid #4a4a6a;
      border-radius: 8px;
      height: 500px;
      overflow-y: auto;
      padding: 12px;
      scroll-behavior: smooth;
    }

    .chat-message {
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .chat-message.user {
      background: #2a2a4a;
      margin-left: auto;
    }

    .chat-message.assistant {
      background: #1a2a3e;
    }

    .message-content {
      color: #e0e0e0;
      line-height: 1.5;
      margin-bottom: 6px;
    }

    .message-time {
      font-size: 11px;
      color: #888;
    }

    /* Custom scrollbar */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #1a1a2e;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #4a4a6a;
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #5a5a7a;
    }
  </style>
</head>
<body>
  <h1>Chat Scroll Performance Test</h1>

  <div class="controls">
    <button onclick="addMessages(10)">Add 10 Messages</button>
    <button onclick="addMessages(50)">Add 50 Messages</button>
    <button onclick="addMessages(100)">Add 100 Messages</button>
    <button onclick="addMessages(500)">Add 500 Messages (Stress Test)</button>
    <button onclick="clearMessages()">Clear All</button>
    <button onclick="scrollToTop()">Scroll to Top</button>
    <button onclick="scrollToBottom()">Scroll to Bottom</button>
    <button onclick="runBenchmark()">Run Benchmark</button>
  </div>

  <div class="metrics">
    <div class="metric">
      <div class="metric-label">Total Messages</div>
      <div class="metric-value" id="total-messages">0</div>
    </div>
    <div class="metric">
      <div class="metric-label">Scroll FPS</div>
      <div class="metric-value" id="fps">--</div>
    </div>
    <div class="metric">
      <div class="metric-label">Average Frame Time</div>
      <div class="metric-value" id="avg-frame-time">--</div>
    </div>
    <div class="metric">
      <div class="metric-label">Render Time (100 msgs)</div>
      <div class="metric-value" id="render-time">--</div>
    </div>
    <div class="metric">
      <div class="metric-label">Memory Usage</div>
      <div class="metric-value" id="memory">--</div>
    </div>
  </div>

  <div class="chat-messages" id="chat-messages">
    <div style="text-align: center; color: #888; padding: 20px;">
      Click "Add Messages" to start testing
    </div>
  </div>

  <script>
    const container = document.getElementById('chat-messages');
    let messageCount = 0;
    let fpsFrames = [];
    let lastFrameTime = performance.now();

    const sampleTexts = {
      user: [
        "안녕하세요, MAMA와 대화 중입니다.",
        "이 메시지는 스크롤 성능 테스트를 위한 샘플입니다.",
        "모바일에서 부드럽게 스크롤되는지 확인해야 합니다.",
        "긴 메시지는 어떻게 렌더링될까요? 여러 줄에 걸친 텍스트가 성능에 영향을 줄 수 있습니다. 특히 100개 이상의 메시지가 있을 때 말이죠.",
        "짧은 메시지",
      ],
      assistant: [
        "네, 이해했습니다. MAMA는 메모리 기반 어시스턴트입니다.",
        "스크롤 성능을 최적화하기 위해 requestAnimationFrame을 사용하고 있습니다.",
        "긴 응답도 테스트해봅시다. 이 메시지는 여러 문장으로 구성되어 있으며, 실제 채팅처럼 보이도록 작성되었습니다. 모바일 기기에서도 부드럽게 스크롤되어야 하며, 60 FPS를 유지하는 것이 목표입니다.",
        "짧은 답변입니다.",
        "코드를 포함한 응답:\n```javascript\nfunction test() {\n  return 'Hello World';\n}\n```\n이런 형식도 잘 렌더링되어야 합니다.",
      ]
    };

    function addMessages(count) {
      const startTime = performance.now();
      const fragment = document.createDocumentFragment();

      for (let i = 0; i < count; i++) {
        const isUser = Math.random() > 0.5;
        const type = isUser ? 'user' : 'assistant';
        const texts = sampleTexts[type];
        const text = texts[Math.floor(Math.random() * texts.length)];

        const msgEl = document.createElement('div');
        msgEl.className = `chat-message ${type}`;
        msgEl.innerHTML = `
          <div class="message-content">${escapeHtml(text)}</div>
          <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
        fragment.appendChild(msgEl);
        messageCount++;
      }

      // Clear placeholder
      if (container.children.length === 1 && container.children[0].textContent.includes('Click')) {
        container.innerHTML = '';
      }

      container.appendChild(fragment);
      container.scrollTop = container.scrollHeight;

      const endTime = performance.now();
      const renderTime = endTime - startTime;

      updateMetrics(renderTime);
      console.log(`Added ${count} messages in ${renderTime.toFixed(2)}ms`);
    }

    function clearMessages() {
      container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Click "Add Messages" to start testing</div>';
      messageCount = 0;
      updateMetrics();
    }

    function scrollToTop() {
      container.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToBottom() {
      container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    }

    function updateMetrics(renderTime = null) {
      document.getElementById('total-messages').textContent = messageCount;

      if (renderTime !== null) {
        const rtEl = document.getElementById('render-time');
        rtEl.textContent = `${renderTime.toFixed(2)}ms`;
        rtEl.className = 'metric-value ' + (renderTime < 100 ? 'good' : renderTime < 300 ? 'warning' : 'bad');
      }

      // Update memory if available
      if (performance.memory) {
        const memMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
        document.getElementById('memory').textContent = `${memMB} MB`;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // FPS monitoring during scroll
    let scrolling = false;
    let scrollTimeout;
    container.addEventListener('scroll', () => {
      if (!scrolling) {
        scrolling = true;
        fpsFrames = [];
        lastFrameTime = performance.now();
        requestAnimationFrame(measureFPS);
      }

      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        scrolling = false;
        calculateFPS();
      }, 200);
    });

    function measureFPS() {
      if (!scrolling) return;

      const now = performance.now();
      const delta = now - lastFrameTime;
      fpsFrames.push(delta);
      lastFrameTime = now;

      requestAnimationFrame(measureFPS);
    }

    function calculateFPS() {
      if (fpsFrames.length === 0) return;

      const avgFrameTime = fpsFrames.reduce((a, b) => a + b, 0) / fpsFrames.length;
      const fps = 1000 / avgFrameTime;

      const fpsEl = document.getElementById('fps');
      fpsEl.textContent = fps.toFixed(1);
      fpsEl.className = 'metric-value ' + (fps >= 55 ? 'good' : fps >= 40 ? 'warning' : 'bad');

      const ftEl = document.getElementById('avg-frame-time');
      ftEl.textContent = `${avgFrameTime.toFixed(2)}ms`;
      ftEl.className = 'metric-value ' + (avgFrameTime <= 18 ? 'good' : avgFrameTime <= 25 ? 'warning' : 'bad');
    }

    async function runBenchmark() {
      console.log('Starting benchmark...');
      clearMessages();

      // Test 1: Add 100 messages
      console.log('Test 1: Adding 100 messages...');
      const start1 = performance.now();
      addMessages(100);
      const time1 = performance.now() - start1;
      console.log(`✓ 100 messages added in ${time1.toFixed(2)}ms`);

      await sleep(1000);

      // Test 2: Scroll performance
      console.log('Test 2: Scroll to top...');
      scrollToTop();
      await sleep(2000);

      console.log('Test 3: Scroll to bottom...');
      scrollToBottom();
      await sleep(2000);

      // Test 4: Add 500 more (stress test)
      console.log('Test 4: Adding 500 more messages (stress test)...');
      const start2 = performance.now();
      addMessages(500);
      const time2 = performance.now() - start2;
      console.log(`✓ 500 messages added in ${time2.toFixed(2)}ms`);

      await sleep(1000);

      console.log('Test 5: Final scroll test...');
      scrollToTop();
      await sleep(2000);
      scrollToBottom();

      console.log('✅ Benchmark complete!');
      console.log(`Total messages: ${messageCount}`);
      console.log(`Performance: ${time1 < 100 ? '✓ PASS' : '✗ FAIL'} (100 msgs < 100ms)`);
      console.log(`Stress test: ${time2 < 500 ? '✓ PASS' : '✗ FAIL'} (500 msgs < 500ms)`);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initial metrics
    updateMetrics();
  </script>
</body>
</html>
