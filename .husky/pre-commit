#!/bin/sh
set -e

# Run lint-staged for staged files (ESLint + Prettier)
npx lint-staged

# Secret scanning with gitleaks
echo "Scanning for secrets..."
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks protect --staged --no-banner
else
  # Check if gitleaks is available via npx
  if npx --yes gitleaks --version >/dev/null 2>&1; then
    # gitleaks available - run scan (will exit non-zero if secrets found)
    npx --yes gitleaks protect --staged --no-banner
  else
    echo "⚠️  gitleaks not installed, skipping secret scan"
  fi
fi

# Sync doc versions with package.json (auto-stage if changed)
node scripts/sync-versions.js
git diff --quiet -- README.md docs/ || git add README.md docs/guides/deployment.md docs/architecture/package-structure.md 2>/dev/null

# Run typecheck for standalone package
echo "Running typecheck..."
pnpm --filter @jungjaehoon/mama-os typecheck 2>/dev/null || pnpm --filter @jungjaehoon/mama-standalone typecheck 2>/dev/null || true

# Run tests for changed packages only (faster commits)
# Uses turbo for caching benefits
echo "Running tests for changed packages..."
CI=true pnpm turbo run test --filter="...[HEAD^1]" --cache-dir=.turbo 2>/dev/null || CI=true pnpm --filter "...[HEAD^1]" test
