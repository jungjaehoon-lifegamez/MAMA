name: Publish to npm

on:
  push:
    tags:
      - 'v*'
      - 'mcp-server-*'
      - 'core-v*'
      - 'mama-core-*'
      - 'os-v*'
      - 'mama-os-*'
      - 'standalone-v*'
      - 'openclaw-v*'
      - 'openclaw-plugin-*'

jobs:
  # Publish mama-core first (other packages depend on it)
  publish-mama-core:
    if: startsWith(github.ref, 'refs/tags/core-v') || startsWith(github.ref, 'refs/tags/mama-core-')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: packages/mama-core
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Publish to npmjs.org
        run: npm publish --access public || echo "Already published on npmjs, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'

      - name: Publish to GitHub Packages
        run: npm publish --access public || echo "Already published on GitHub Packages, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-mcp-server:
    if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/mcp-server-')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: packages/mcp-server
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Replace workspace protocol
        run: |
          # Replace workspace:* with actual version from mama-core
          CORE_VERSION=$(node -p "require('../mama-core/package.json').version")
          sed -i "s/\"workspace:\*\"/\"^$CORE_VERSION\"/" package.json
          cat package.json

      - name: Publish to npmjs.org
        run: npm publish --access public || echo "Already published on npmjs, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'

      - name: Publish to GitHub Packages
        run: npm publish --access public || echo "Already published on GitHub Packages, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-openclaw-plugin:
    if: startsWith(github.ref, 'refs/tags/openclaw-v') || startsWith(github.ref, 'refs/tags/openclaw-plugin-')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: packages/openclaw-plugin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Replace workspace protocol
        run: |
          # Replace workspace:* with actual version from mama-core
          CORE_VERSION=$(node -p "require('../mama-core/package.json').version")
          sed -i "s/\"workspace:\*\"/\"^$CORE_VERSION\"/" package.json
          cat package.json

      - name: Publish to npmjs.org
        run: npm publish --access public || echo "Already published on npmjs, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'

      - name: Publish to GitHub Packages
        run: npm publish --access public || echo "Already published on GitHub Packages, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish mama-os (standalone)
  publish-mama-os:
    if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/os-v') || startsWith(github.ref, 'refs/tags/mama-os-') || startsWith(github.ref, 'refs/tags/standalone-v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    defaults:
      run:
        working-directory: packages/standalone
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Replace workspace protocol
        run: |
          # Replace workspace:* with actual version from mama-core
          CORE_VERSION=$(node -p "require('../mama-core/package.json').version")
          sed -i "s/\"workspace:\*\"/\"^$CORE_VERSION\"/" package.json
          cat package.json

      - name: Publish to npmjs.org
        run: npm publish --access public || echo "Already published on npmjs, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'

      - name: Publish to GitHub Packages
        run: npm publish --access public || echo "Already published on GitHub Packages, skipping"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
